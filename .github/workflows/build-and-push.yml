name: Build & Push CYP-Registry

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  REGISTRY_URL: ${{ secrets.REGISTRY_URL }}          # 例如 registry.example.com
  IMAGE_NAME: cyp-registry-single                   # 推送到仓库中的镜像名称

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      # 后端：Go 代码测试
      - name: Set up Go
        uses: actions/setup-go@v3
        with:
          go-version-file: go.mod

      - name: Run Go tests
        run: go test ./...

      # 前端：确保 web 能成功安装依赖并构建
      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            web/package-lock.json

      - name: Install frontend dependencies
        working-directory: web
        run: npm ci --legacy-peer-deps --no-audit --progress=false

      - name: Build frontend
        working-directory: web
        run: npm run build

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_URL }}
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PAT }}      # 建议使用 PAT，与后端 PAT 设计保持一致

      - name: Build and push Docker image (Dockerfile.single)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.single
          push: true
          tags: |
            ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:latest
            ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          cache-from: type=registry,ref=${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:buildcache,mode=max

