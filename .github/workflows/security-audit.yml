name: Security Audit Pipeline

on:
  schedule:
    # 每周一凌晨执行安全扫描
    - cron: '0 0 * * 1'
  push:
    branches: [main, develop]
    paths:
      - '**.go'
      - 'go.mod'
      - 'go.sum'
  pull_request:
    branches: [main, develop]

env:
  GO_VERSION: '1.24'
  GOPROXY: https://goproxy.cn,direct

jobs:
  # 1. Go安全扫描
  gosec-scan:
    name: Go Security Scan
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install gosec
        run: go install github.com/securego/gosec/v2/cmd/gosec@latest

      - name: Run gosec
        run: |
          gosec -fmt=sarif -out=gosec-results.sarif ./...
          
      - name: Upload SARIF results
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: gosec-results.sarif
          category: gosec

  # 2. Go依赖漏洞扫描 (GoNancy)
  dependency-scan:
    name: Go Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install GoNancy (nancy)
        run: go install github.com/sonatype-nexus-community/nancy@latest

      - name: Run GoNancy
        run: |
          go list -json -m all > /tmp/go-mod-list.json
          nancy sleuth --template=embedded --output-file=nancy-results.sarif --exclude-vulnerability-file=.nancy-ignore.json $(cat /tmp/go-mod-list.json | jq -r '.Path') || true
        continue-on-error: true

      - name: Upload Nancy SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: nancy-results.sarif
          category: nancy
        continue-on-error: true

  # 3. 前端依赖安全扫描
  frontend-security:
    name: Frontend Security Scan
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./web
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmmirror.com'

      - name: Install dependencies
        run: npm ci --registry=https://registry.npmmirror.com

      - name: Run npm audit
        run: npm audit --audit-level=high --json > npm-audit-results.json || true

      - name: Upload npm audit results
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-results
          path: web/npm-audit-results.json
        continue-on-error: true

  # 4. Docker镜像安全扫描
  container-scan:
    name: Container Image Scan
    runs-on: ubuntu-latest
    if: false # 仅在构建镜像时启用
    permissions:
      security-events: write
      actions: read
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          docker build -f Dockerfile.single -t cyp-registry:${{ github.sha }} .

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'cyp-registry:${{ github.sha }}'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'

      - name: Upload Trivy SARIF results
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-results.sarif
          category: trivy

  # 5. 静态代码分析
  static-analysis:
    name: Static Code Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install staticcheck
        run: go install honnef.co/go/tools/cmd/staticcheck@latest

      - name: Run staticcheck
        run: staticcheck ./...

      - name: Install go vet
        run: go install golang.org/x/tools/go/analysis/cmd/vet@latest

      - name: Run go vet
        run: go vet ./...

  # 6. 敏感信息检测
  secrets-detection:
    name: Secrets Detection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install gitleaks
        run: |
          wget -O /tmp/gitleaks.tar.gz https://github.com/gitleaks/gitleaks/releases/download/v8.18.0/gitleaks_8.18.0_linux_x64.tar.gz
          tar -xzf /tmp/gitleaks.tar.gz -C /tmp
          sudo mv /tmp/gitleaks /usr/local/bin/

      - name: Run gitleaks
        run: |
          gitleaks detect --source=. --verbose --redact --leaks-exit-code=1 || true
        continue-on-error: true

  # 7. 安全报告生成
  security-report:
    name: Security Report
    runs-on: ubuntu-latest
    needs: [gosec-scan, dependency-scan, frontend-security, static-analysis, secrets-detection]
    if: always()
    steps:
      - name: Generate security report
        run: |
          echo "# CYP-Registry 安全审计报告" > SECURITY_REPORT.md
          echo "生成时间: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> SECURITY_REPORT.md
          echo "" >> SECURITY_REPORT.md
          echo "## 扫描结果汇总" >> SECURITY_REPORT.md
          echo "---" >> SECURITY_REPORT.md
          
          # 统计各扫描结果
          for result in gosec-results.sarif nancy-results.sarif npm-audit-results.json; do
            if [ -f "$result" ]; then
              echo "✅ $result 存在" >> SECURITY_REPORT.md
            else
              echo "⚠️ $result 不存在或扫描未完成" >> SECURITY_REPORT.md
            fi
          done
          
          cat SECURITY_REPORT.md

      - name: Upload security report
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: SECURITY_REPORT.md

