我将为您设计一款符合您规范体系的容器私有仓库管理系统。首先让我搜索相关技术参考和最佳实践。
基于您提供的规范体系和网络搜索结果，我为您设计了**CYP-Registry**——一款面向个人开发者的中文私有镜像仓库管理系统。以下是完整的设计文档：

---

# CYP-Registry 私有镜像仓库管理系统设计文档

| **项目** | **内容** |
|---------|---------|
| **文档名称** | CYP-Registry 系统设计文档 |
| **版本号** | v1.0.2 |
| **作者** | CYP |
| **联系方式** | nasDSSCYP@outlook.com |
| **更新日期** | 2026-02-24 |
| **项目宣传词** | 科技赋能，规范引领 —— 安全可控的私有镜像仓库解决方案 |

---

## 一、系统概述

### 版本变更记录

| 版本号 | 日期       | 变更内容 |
|--------|------------|----------|
| v1.0.3 | 2026-02-25 | 调整个人访问令牌（PAT）有效期语义：支持“永不过期”，修复前端有效期展示不一致的问题；将“撤销访问令牌”改为真实删除并在数据库归档，统一前后端删除文案与接口返回信息 |
| v1.0.2 | 2026-02-24 | 修复访问令牌创建成功后复制再次查看时列表中缺失的问题，完善访问令牌按需加载与撤销流程，并补齐前端自动化测试选择器 |
| v1.0.1 | 2026-02-24 | 修复项目详情页成员管理与镜像信息展示中的假数据问题，前后端统一版本号并补充接口文档说明 |
| v1.0.0 | 2026-01-31 | 初始版本 |

### 1.1 设计目标

CYP-Registry 是一款面向个人开发者和中小型团队的中文私有容器镜像仓库管理系统，遵循**全平台通用开发规范**，提供：
- **零兼容性问题**：严格遵循 OCI Distribution Specification
- **零意外中断**：高可用架构设计，支持自动故障恢复
- **零回归缺陷**：完整的自动化测试与镜像扫描流程

### 1.2 核心功能

| 功能模块 | 功能描述 | 优先级 |
|---------|---------|--------|
| **镜像仓库管理** | 支持公开/私有项目，细粒度权限控制 | P0 |
| **镜像源代理** | 支持 Docker Hub、阿里云等镜像代理与缓存 | P0 |
| **自动化工作流** | 集成 GitHub Actions/GitLab CI，自动构建推送 | P1 |
| **安全扫描** | 集成 Trivy 自动漏洞扫描 | P1 |
| **多租户隔离** | 基于项目的 RBAC 权限模型 | P2 |

### 1.3 技术架构

```
┌─────────────────────────────────────────────────────────────────────┐
│                         用户交互层 (Presentation)                     │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐                │
│  │  Web 管理界面 │ │  Docker CLI  │ │  GitHub Actions│                │
│  │  (Vue3+TS)   │ │  (Registry API)│ │  (Webhook)    │                │
│  └──────────────┘ └──────────────┘ └──────────────┘                │
└─────────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         网关层 (Gateway)                             │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                      Nginx 反向代理                             │  │
│  │  - SSL 终止 │ - 负载均衡 │ - 请求路由 │ - 速率限制               │  │
│  └──────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
                                  │
              ┌───────────────────┼───────────────────┐
              ▼                   ▼                   ▼
┌──────────────────┐ ┌──────────────────┐ ┌──────────────────┐
│   核心服务层      │ │   镜像存储层      │ │   数据处理层      │
│  ┌────────────┐  │ │  ┌────────────┐  │ │  ┌────────────┐  │
│  │ Core API   │  │ │  │ Distribution│  │ │  │ PostgreSQL │  │
│  │ (Go/Gin)   │  │ │  │ (Registry) │  │ │  │ (主数据库)  │  │
│  └────────────┘  │ │  └────────────┘  │ │  └────────────┘  │
│  ┌────────────┐  │ │  ┌────────────┐  │ │  ┌────────────┐  │
│  │ Job Service│  │ │  │ MinIO      │  │ │  │ Redis      │  │
│  │ (任务队列) │  │ │  │ (对象存储)  │  │ │  │ (缓存/会话) │  │
│  └────────────┘  │ │  └────────────┘  │ │  └────────────┘  │
│  ┌────────────┐  │ │  ┌────────────┐  │ │                  │
│  │ Scanner    │  │ │  │ Local FS   │  │ │                  │
│  │ (Trivy)    │  │ │  │ (本地存储)  │  │ │                  │
│  └────────────┘  │ │  └────────────┘  │ │                  │
└──────────────────┘ └──────────────────┘ └──────────────────┘
```

---

## 二、功能模块设计

### 2.1 用户认证模块（遵循用户认证规范）

#### 2.1.1 认证方式支持

| 认证方式 | 实现方案 | 备注 |
|---------|---------|------|
| **账号密码** | bcrypt 加密存储，支持 MFA | 主认证方式 |
| **Personal Access Token** | pat_v1_{uuid} 格式 | 用于 CLI/API 访问 |
| **Robot Account** | robot$projectName 格式 | 用于 CI/CD 自动化 |
| **OAuth2** | GitHub/GitLab 集成 | 第三方登录 |

#### 2.1.2 个人访问令牌 (PAT) 规范

根据《全平台通用用户认证设计规范》第 2.5 节：

```go
// 令牌生成规则
func GeneratePAT() string {
    // 格式: pat_v1_<32位十六进制>
    // 示例: pat_v1_a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6
    uuid := uuid.New().String()
    return fmt.Sprintf("pat_v1_%s", strings.ReplaceAll(uuid, "-", ""))
}

// 存储规则: 仅存储 bcrypt 哈希值
type PersonalAccessToken struct {
    ID          string    `gorm:"primaryKey"`
    UserID      string    `gorm:"index"`
    Name        string    // 令牌名称（用户自定义）
    HashedToken string    // bcrypt 哈希值
    Scopes      []string  // 权限范围: ["repo:read", "repo:write"]
    CreatedAt   time.Time
    LastUsedAt  time.Time
    ExpiresAt   *time.Time // 可选过期时间
}
```

#### 2.1.3 恶意行为检测与封禁

根据用户认证规范第 7.5 节：

| 检测类型 | 触发条件 | 封禁级别 | 处理方式 |
|---------|---------|---------|---------|
| **暴力破解** | 同一账号 1 分钟失败 ≥ 10 次 | Level 1 | 账号锁定 24 小时 |
| **批量验证** | 单 IP 1 小时验证不同账号 ≥ 100 个 | Level 2 | 永久封禁 IP |
| **批量注册** | 单 IP 1 小时注册 ≥ 10 个 | Level 2 | 永久封禁 IP 及设备 |
| **Token 泄露尝试** | 高频无效 Token 请求 | Level 1 | IP 临时封禁 |

### 2.2 镜像仓库管理模块

#### 2.2.1 项目（Project）模型

```sql
-- 项目表结构（遵循数据库命名规范）
CREATE TABLE registry_projects (
    id              BIGSERIAL PRIMARY KEY,
    project_name    VARCHAR(255) NOT NULL UNIQUE, -- 小写下划线命名
    owner_id        BIGINT NOT NULL REFERENCES users(id),
    visibility      VARCHAR(20) DEFAULT 'private', -- public/private
    storage_quota   BIGINT DEFAULT 10737418240, -- 默认 10GB
    used_storage    BIGINT DEFAULT 0,
    auto_scan       BOOLEAN DEFAULT true, -- 推送自动扫描
    proxy_enabled   BOOLEAN DEFAULT false, -- 代理模式
    proxy_upstream  VARCHAR(255), -- 上游源地址
    created_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at      TIMESTAMP -- 软删除
);

-- 索引设计
CREATE INDEX idx_projects_owner ON registry_projects(owner_id);
CREATE INDEX idx_projects_visibility ON registry_projects(visibility) WHERE deleted_at IS NULL;
```

#### 2.2.2 权限矩阵（RBAC）

| 角色 | 公开项目权限 | 私有项目权限 | 适用场景 |
|------|-------------|-------------|---------|
| **项目管理员** | 全部权限 | 全部权限 | 项目 Owner |
| **维护人员** | Push/Pull | Push/Pull | DevOps 工程师 |
| **开发人员** | Pull | Push/Pull | 开发团队 |
| **访客** | Pull | Pull（需授权） | 外部协作 |
| **机器人账户** | Pull/Push | Pull/Push（限定仓库） | CI/CD |

### 2.3 镜像源管理模块

#### 2.3.1 镜像代理与缓存

支持配置多个上游镜像源，实现拉取加速：

```yaml
# config/proxy.yml
proxy_registries:
  - name: "docker-hub"
    url: "https://registry-1.docker.io"
    type: "docker-hub"
    cache_ttl: "24h"
    insecure: false
    
  - name: "aliyun-mirror"
    url: "https://registry.aliyuncs.com"
    type: "standard"
    cache_ttl: "12h"
    
  - name: "internal-registry"
    url: "https://internal.company.com"
    type: "standard"
    username: "${INTERNAL_USER}"
    password: "${INTERNAL_PASS}"
```

#### 2.3.2 镜像同步规则

支持配置自动同步策略：

| 同步模式 | 说明 | 触发条件 |
|---------|------|---------|
| **事件驱动** | 上游镜像更新时自动同步 | Webhook 触发 |
| **定时同步** | 按 Cron 表达式定时检查 | Cron 调度 |
| **手动同步** | 用户手动触发 | API 调用 |

### 2.4 自动化工作流配置

#### 2.4.1 GitHub Actions 集成

根据《全平台Git与GitHub工作流管理规范》：

```yaml
# .github/workflows/build-and-push.yml (标准工作流模板示例)
name: 构建并推送至 CYP-Registry

on:
  push:
    branches: [ main ]
    tags: [ 'v*.*.*' ]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 配置 QEMU
        uses: docker/setup-qemu-action@v3

      - name: 配置 Buildx
        uses: docker/setup-buildx-action@v3

      - name: 登录 CYP-Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.CYP_REGISTRY_URL }}
          username: ${{ secrets.CYP_REGISTRY_USERNAME }}
          password: ${{ secrets.CYP_REGISTRY_TOKEN }}

      - name: 构建并推送
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ secrets.CYP_REGISTRY_URL }}/${{ github.repository }}:latest
            ${{ secrets.CYP_REGISTRY_URL }}/${{ github.repository }}:${{ github.ref_name }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
```

#### 2.4.2 自动构建触发器

系统支持以下触发方式：

| 触发器类型 | 配置方式 | 安全验证 |
|-----------|---------|---------|
| **GitHub Webhook** | 自动生成 Webhook URL | HMAC-SHA256 签名验证 |
| **GitLab Webhook** | 支持 CI 事件触发 | Secret Token 验证 |
| **Generic Webhook** | 自定义 HTTP 端点 | IP 白名单 + Token |

---

## 三、界面设计规范（科技感主题）

### 3.1 整体布局

遵循《全平台通用界面开发设计规范（科技感主题）》，采用**侧边导航栏 + 顶部导航栏**布局：

```
┌───────────────────────────────────────────────────────────────────┐
│  [Logo] CYP-Registry    🔍 全局搜索    [🌙] [🔔] [👤 用户名]        │  ← 顶部导航栏 (56px)
├──────────┬────────────────────────────────────────────────────────┤
│          │                                                        │
│  📊 概览  │                    内容区域                           │
│  📦 项目  │                    (Flex布局)                          │
│  🔄 同步  │                                                        │
│  🔒 安全  │                                                        │
│  ⚙️ 配置  │                                                        │
│  📋 日志  │                                                        │
│          │                                                        │
│          ├────────────────────────────────────────────────────────┤
│          │  版本号: V1.0 | 版权所有 © 2026 CYP | 科技赋能,规范引领  │  ← 底部信息 (12px)
└──────────┴────────────────────────────────────────────────────────┘
  ↑
侧边导航 (240px展开/80px折叠)
```

### 3.2 配色方案

| 用途 | 颜色值 | 变量名 |
|------|--------|--------|
| **主色（科技蓝）** | `#1E88E5` | `--color-primary` |
| **成功色** | `#4CAF50` | `--color-success` |
| **警告色** | `#FFC107` | `--color-warning` |
| **错误色** | `#F44336` | `--color-error` |
| **主文本** | `#212121` | `--text-primary` |
| **次文本** | `#757575` | `--text-secondary` |
| **背景色** | `#F5F7FA` | `--bg-secondary` |

### 3.3 核心界面原型

#### 3.3.1 项目管理界面

```
┌─────────────────────────────────────────────────────────────────┐
│  项目管理                                    [+ 新建项目]        │
├─────────────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────────────┐ │
│  │ 🔍 搜索项目...    [公开 ▼] [排序 ▼]    [列表/卡片]        │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │ 📦 project-a │  │ 📦 project-b │  │ 📦 project-c │         │
│  │              │  │              │  │              │         │
│  │ 公开 / 私有   │  │ 私有         │  │ 公开         │         │
│  │ 存储: 2.4GB  │  │ 存储: 0GB    │  │ 存储: 5.1GB  │         │
│  │ 镜像: 12     │  │ 镜像: 0      │  │ 镜像: 34     │         │
│  │              │  │              │  │              │         │
│  │ [管理] [删除]│  │ [管理] [删除]│  │ [管理] [删除]│         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
└─────────────────────────────────────────────────────────────────┘
```

#### 3.3.2 镜像详情界面

```
┌─────────────────────────────────────────────────────────────────┐
│  project-a / nginx                              [推送命令] [删除] │
├─────────────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  latest           2小时前           156MB    [扫描: ✅]    │ │
│  │  v1.2.0           3天前             152MB    [扫描: ✅]    │ │
│  │  v1.1.0           1周前             148MB    [扫描: ⚠️]    │ │
│  │                    └─ 发现 3 个中危漏洞                    │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  [标签] [漏洞扫描] [构建历史] [权限管理]                         │
│                                                                 │
│  ─────────────────────────────────────────────────────────────  │
│  镜像层信息                                                      │
│  ┌──────────────┬──────────────┬──────────────────────────┐    │
│  │ 层 ID        │ 大小         │ 创建指令                 │    │
│  ├──────────────┼──────────────┼──────────────────────────┤    │
│  │ a1b2c3d4     │ 56MB         │ ADD file:xxx in /        │    │
│  │ e5f6g7h8     │ 100MB        │ RUN apt-get update       │    │
│  └──────────────┴──────────────┴──────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
```

---

## 四、数据库设计

### 4.1 核心表结构（遵循数据库规范）

```sql
-- 使用 snake_case 命名，UTF8MB4 字符集
CREATE TABLE registry_users (
    id                  BIGSERIAL PRIMARY KEY,
    username            VARCHAR(32) NOT NULL UNIQUE,
    email               VARCHAR(255) UNIQUE,
    phone               VARCHAR(20) UNIQUE,
    password_hash       VARCHAR(255) NOT NULL, -- bcrypt with cost 12
    status              SMALLINT DEFAULT 1, -- 1:active, 2:locked, 3:banned
    is_admin            BOOLEAN DEFAULT false,
    mfa_enabled         BOOLEAN DEFAULT false,
    mfa_secret          VARCHAR(255), -- 加密存储
    created_at          TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at          TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 个人访问令牌表
CREATE TABLE registry_pat (
    id                  BIGSERIAL PRIMARY KEY,
    user_id             BIGINT NOT NULL REFERENCES registry_users(id) ON DELETE CASCADE,
    name                VARCHAR(255),
    token_hash          VARCHAR(255) NOT NULL, -- 仅存储哈希
    scopes              JSONB DEFAULT '[]', -- ["repo:read", "repo:write"]
    last_used_at        TIMESTAMP,
    expires_at          TIMESTAMP,
    created_at          TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 镜像表
CREATE TABLE registry_artifacts (
    id                  BIGSERIAL PRIMARY KEY,
    project_id          BIGINT NOT NULL REFERENCES registry_projects(id) ON DELETE CASCADE,
    repository_name     VARCHAR(255) NOT NULL,
    digest              VARCHAR(255) NOT NULL, -- sha256:xxx
    size_bytes          BIGINT NOT NULL,
    content_type        VARCHAR(100),
    media_type          VARCHAR(100),
    scan_status         VARCHAR(20) DEFAULT 'pending', -- pending, scanning, success, failed
    vuln_summary        JSONB, -- 漏洞统计 {"critical": 0, "high": 2, "medium": 5}
    pushed_by           BIGINT REFERENCES registry_users(id),
    pushed_at           TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT unique_digest UNIQUE (project_id, repository_name, digest)
);

-- 审计日志表（保留 90 天）
CREATE TABLE registry_audit_logs (
    id                  BIGSERIAL PRIMARY KEY,
    user_id             BIGINT REFERENCES registry_users(id),
    action              VARCHAR(50) NOT NULL, -- push, pull, delete, login
    resource            VARCHAR(255), -- project/repo:tag
    ip_address          INET,
    user_agent          TEXT,
    status              VARCHAR(20), -- success, failure
    created_at          TIMESTAMP DEFAULT CURRENT_TIMESTAMP
) PARTITION BY RANGE (created_at); -- 按时间分区
```

### 4.2 索引设计

```sql
-- 性能优化索引
CREATE INDEX CONCURRENTLY idx_artifacts_project_repo ON registry_artifacts(project_id, repository_name);
CREATE INDEX CONCURRENTLY idx_artifacts_digest ON registry_artifacts USING hash(digest);
CREATE INDEX CONCURRENTLY idx_audit_logs_user_created ON registry_audit_logs(user_id, created_at);
CREATE INDEX CONCURRENTLY idx_audit_logs_action ON registry_audit_logs(action, created_at);

-- 清理策略：审计日志自动删除 90 天前数据（根据数据库规范 2.1 节）
CREATE OR REPLACE FUNCTION cleanup_old_audit_logs() RETURNS void AS $$
BEGIN
    DELETE FROM registry_audit_logs WHERE created_at < NOW() - INTERVAL '90 days';
END;
$$ LANGUAGE plpgsql;
```

---

## 五、API 接口设计

### 5.1 标准响应格式（遵循开发规范第 6.3 节）

```json
{
  "code": 20000,
  "message": "操作成功",
  "data": {},
  "timestamp": 1704067200000,
  "trace_id": "req_20260131_001"
}
```

### 5.2 核心 API 列表

| 方法 | 路径 | 描述 | 认证 |
|------|------|------|------|
| **用户认证** |
| POST | `/api/v1/auth/login` | 用户登录 | 否 |
| POST | `/api/v1/auth/refresh` | 刷新 Token | 是 |
| GET | `/api/v1/user/tokens` | 列出 PAT（掩码） | 是 |
| POST | `/api/v1/user/tokens` | 创建 PAT | 是 |
| DELETE | `/api/v1/user/tokens/:id` | 删除 PAT | 是 |
| **项目管理** |
| GET | `/api/v1/projects` | 列出项目 | 是 |
| POST | `/api/v1/projects` | 创建项目 | 是 |
| GET | `/api/v1/projects/:id` | 项目详情 | 是 |
| PUT | `/api/v1/projects/:id` | 更新项目 | 是 |
| DELETE | `/api/v1/projects/:id` | 删除项目 | 是 |
| **镜像管理** |
| GET | `/api/v1/projects/:id/repositories` | 列出仓库 | 是 |
| GET | `/api/v1/repositories/:repo/artifacts` | 列出镜像 | 是 |
| DELETE | `/api/v1/artifacts/:digest` | 删除镜像 | 是 |
| GET | `/api/v1/artifacts/:digest/vulnerabilities` | 漏洞详情 | 是 |
| **工作流** |
| GET | `/api/v1/webhooks` | 列出 Webhook | 是 |
| POST | `/api/v1/webhooks` | 创建 Webhook | 是 |
| POST | `/api/v1/webhooks/:id/test` | 测试 Webhook | 是 |

### 5.3 Docker Registry API 兼容

实现 Docker Registry HTTP API V2 规范[^(32)]，支持标准 Docker CLI 操作：

```
GET   /v2/                     # API 版本检查
GET   /v2/:name/tags/list      # 列出标签
GET   /v2/:name/manifests/:ref # 获取清单
PUT   /v2/:name/manifests/:ref # 推送清单
GET   /v2/:name/blobs/:digest  # 拉取层
POST  /v2/:name/blobs/uploads/ # 开始上传
```

---

## 六、安全设计

### 6.1 镜像安全扫描

集成 Trivy 进行漏洞扫描[^(39)]：

```yaml
# 扫描配置
scanner:
  type: trivy
  timeout: 10m
  severity_threshold: HIGH # 阻止高危漏洞
  auto_scan_on_push: true
  ignore_unfixed: false
```

**扫描策略**：
| 漏洞等级 | 处理方式 | 阻断部署 |
|---------|---------|---------|
| **Critical** | 立即告警，标记镜像 | 是 |
| **High** | 警告，通知项目管理员 | 可配置 |
| **Medium/Low** | 记录，定期报告 | 否 |

### 6.2 传输与存储安全

| 层级 | 措施 | 实现 |
|------|------|------|
| **传输** | TLS 1.3 加密 | Nginx 配置 SSL |
| **存储** | 镜像层加密 | AES-256-GCM |
| **敏感数据** | 加密存储 | bcrypt (密码), AES (Token) |
| **审计** | 完整操作日志 | 不可篡改，保留 90 天 |

---

## 七、部署架构（遵循容器规范）

### 7.1 Docker Compose 配置

根据《全平台通用容器开发设计规范》：

```yaml
# docker-compose.yml
version: '3.8'

services:
  nginx:
    image: nginx:1.25-alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
    depends_on:
      - core
    networks:
      - cyp-network

  core:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - GOPROXY=https://goproxy.cn,direct
    environment:
      - DB_HOST=postgres
      - DB_PASSWORD=${DB_PASSWORD} # 来自环境变量
      - REDIS_HOST=redis
      - STORAGE_TYPE=minio # 或 filesystem
    volumes:
      - ./data:/data
    depends_on:
      - postgres
      - redis
      - minio
    networks:
      - cyp-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 3s
      retries: 3
    restart: unless-stopped

  postgres:
    image: postgres:15-alpine
    environment:
      - POSTGRES_USER=cyp_registry
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - POSTGRES_DB=registry
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - cyp-network
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/data
    networks:
      - cyp-network
    restart: unless-stopped

  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      - MINIO_ROOT_USER=${MINIO_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_PASSWORD}
    volumes:
      - minio_data:/data
    networks:
      - cyp-network
    restart: unless-stopped
  
  scanner:
    image: aquasec/trivy:latest
    command: server --listen 0.0.0.0:8080
    networks:
      - cyp-network
    restart: unless-stopped

networks:
  cyp-network:
    driver: bridge

volumes:
  postgres_data:
  redis_data:
  minio_data:
```

### 7.2 Dockerfile（多阶段构建）

```dockerfile
# 构建阶段（遵循容器规范 1.3 节）
FROM golang:1.22-alpine AS builder
WORKDIR /app
COPY go.mod go.sum ./
# 使用国内代理加速
RUN go env -w GOPROXY=https://goproxy.cn,direct && \
    go mod download
COPY . .
RUN CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o registry-server ./cmd/server

# 运行阶段
FROM alpine:3.19
WORKDIR /app

# 安装 CA 证书（用于 TLS 验证）
RUN apk --no-cache add ca-certificates tzdata && \
    adduser -D -u 1000 appuser

# 从构建阶段复制二进制文件
COPY --from=builder /app/registry-server .

# 非 root 用户运行（遵循安全规范）
USER appuser

EXPOSE 8080

# 健康检查
HEALTHCHECK --interval=30s --timeout=3s --retries=3 \
  CMD wget -q --spider http://localhost:8080/health || exit 1

ENTRYPOINT ["./registry-server"]
```

---

## 八、合规与声明

### 8.1 法律合规（遵循数据处理模板）

根据《个人全平台通用声明与数据处理模板》：

- **数据分类**：用户密码（bcrypt 哈希）、个人信息（邮箱/手机）、审计日志（操作记录）
- **存储期限**：审计日志 90 天自动清理，Token 过期自动失效
- **用户权利**：支持数据导出（数据可携带权）、账户注销（72 小时内处理）
- **跨境传输**：如部署在境外服务器，需遵循第十一章跨境数据传输声明

### 8.2 开源许可

| 组件 | 许可协议 | 来源 |
|------|---------|------|
| Trivy | Apache 2.0 | GitHub - aquasecurity/trivy |
| Distribution | Apache 2.0 | CNCF 项目 |
| PostgreSQL | PostgreSQL License | 官方 |
| MinIO | AGPL v3 | 官方 |

---

## 九、附录

### 9.1 目录结构（遵循开发规范）

```
cyp-registry/
├── docs/                    # 文档目录
│   ├── api/                 # API 文档
│   ├── design/              # 设计文档
│   └── deploy/              # 部署指南
├── src/                     # 源代码
│   ├── common/              # 公共模块
│   │   ├── utils/           # 工具函数
│   │   ├── middleware/      # 中间件
│   │   └── config/          # 配置管理
│   ├── modules/             # 功能模块
│   │   ├── user/            # 用户模块
│   │   ├── project/         # 项目模块
│   │   ├── registry/        # 镜像仓库
│   │   ├── scanner/         # 安全扫描
│   │   └── webhook/         # 工作流
│   └── main.go              # 入口文件
├── web/                     # 前端代码（Vue3）
├── scripts/                 # 自动化脚本
├── .github/                 # GitHub Actions 工作流
├── docker-compose.yml
├── Dockerfile
└── README.md
```

### 9.2 快速开始

```bash
# 1. 克隆仓库（示例）
git clone https://github.com/cyp/cyp-registry.git

# 2. 配置环境变量
cp .env.example .env
# 编辑 .env 配置数据库密码、存储密钥等

# 3. 启动服务（使用国内镜像加速）
docker-compose up -d

# 4. 初始化管理员账户
docker-compose exec core ./registry-server migrate
docker-compose exec core ./registry-server create-admin --username admin --password Admin@123

# 5. 访问界面
# https://localhost （默认自签名证书）
```

---

## 十、版本历史

| 版本 | 日期 | 修订内容 | 修订人 |
|------|------|---------|--------|
| v1.0.0 | 2026-01-31 | 初始版本发布，包含核心架构设计 | CYP |

---

**联系方式**：nasDSSCYP@outlook.com  
**文档版权**：© 2026 CYP 保留所有权利