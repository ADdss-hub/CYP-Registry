# 功能检查和改进总结

## 概述

本次检查和改进了三个功能：
1. 检查仓库的公开/私有功能
2. 检查项目详情页面的导入功能，添加自动创建项目功能
3. 将日志清理改成15天自动清理一次

## 1. 仓库公开/私有功能检查

### 检查结果

✅ **功能完整实现**

### 后端实现

1. **数据模型** (`src/modules/project/service/project_service.go`):
   - ✅ 项目模型包含 `IsPublic` 字段（bool类型）
   - ✅ 创建项目时支持设置 `isPublic` 参数
   - ✅ 更新项目时支持修改 `isPublic` 字段

2. **权限检查** (`src/modules/project/service/project_service.go`):
   ```go
   // 公开项目允许pull操作
   if project.IsPublic && action == "pull" {
       return true, nil
   }
   ```
   - ✅ 公开项目允许匿名用户拉取镜像
   - ✅ 私有项目需要认证和权限

3. **API接口** (`src/modules/project/controller/project_controller.go`):
   - ✅ 创建项目API支持 `is_public` 参数
   - ✅ 更新项目API支持修改 `is_public` 字段

### 前端实现

1. **项目列表页面** (`web/src/views/project/ProjectListView.vue`):
   - ✅ 显示项目公开/私有状态
   - ✅ 创建项目时可以选择公开/私有

2. **项目详情页面** (`web/src/views/project/ProjectDetailView.vue`):
   - ✅ 显示项目公开/私有状态（带徽章）
   - ✅ 项目设置中可以修改公开/私有状态
   - ✅ 使用 `CypCheckbox` 组件："公开项目（允许匿名拉取）"

### 功能状态

| 功能 | 状态 | 说明 |
|------|------|------|
| 后端数据模型 | ✅ | 有 `IsPublic` 字段 |
| 权限检查 | ✅ | 公开项目允许匿名拉取 |
| 创建项目API | ✅ | 支持设置公开/私有 |
| 更新项目API | ✅ | 支持修改公开/私有 |
| 前端显示 | ✅ | 列表和详情都显示状态 |
| 前端设置 | ✅ | 创建和编辑都可以设置 |

### 总结

仓库的公开/私有功能已完整实现，包括：
- ✅ 后端数据模型和权限检查
- ✅ API接口支持
- ✅ 前端界面显示和设置
- ✅ 公开项目允许匿名拉取镜像

## 2. 项目详情页面导入功能检查

### 检查结果

✅ **导入功能已实现（支持从 URL 导入镜像、异步任务与进度查询）**  
✅ **自动创建项目功能已实现（项目不存在时按规则自动创建私有项目）**

### 原有功能

1. **前端界面** (`web/src/views/project/ProjectDetailView.vue`):
   - ✅ "从 URL 添加" 按钮已存在
   - ✅ 导入对话框已实现
   - ✅ 支持输入镜像URL、目标镜像名、标签、认证信息
   - ✅ 进度显示和任务轮询已实现

2. **后端API** (`src/modules/imageimport/controller/image_import_controller.go`):
   - ✅ `POST /api/v1/projects/{project_id}/images/import` 接口已实现
   - ✅ 原有逻辑：要求项目必须存在

### 新增功能：自动创建项目

**问题**: 原有实现要求项目必须存在，如果项目不存在会返回404错误。

**解决方案**: 添加自动创建项目功能，类似 `InitiateBlobUpload` 中的 `ensureProjectExists`，并已在导入接口中落地实现。

**实现** (`src/modules/imageimport/controller/image_import_controller.go`):

```go
// 验证项目是否存在，如果不存在则自动创建
project, err := c.projectSvc.GetProject(ctx.Request.Context(), projectID.String())
if err != nil {
    // 项目不存在，尝试自动创建
    // 从目标镜像名中提取项目名（如果目标镜像名包含斜杠，第一段是项目名）
    projectName := projectID.String() // 默认使用项目ID作为项目名
    
    // 如果指定了目标镜像名，尝试从中提取项目名
    if req.TargetImage != "" {
        // 目标镜像名格式可能是 "project/image" 或 "image"
        if idx := strings.Index(req.TargetImage, "/"); idx > 0 {
            projectName = req.TargetImage[:idx]
        } else {
            // 如果目标镜像名不包含斜杠，使用项目ID作为项目名
            projectName = projectID.String()
        }
    }
    
    // 自动创建项目
    createdProject, createErr := c.projectSvc.CreateProject(
        ctx.Request.Context(),
        projectName,
        "Auto created from image import",
        userID.String(),
        false, // 默认私有
        0,     // 无存储限制
    )
    if createErr != nil {
        response.NotFound(ctx, "project not found and failed to create: "+createErr.Error())
        return
    }
    project = createdProject
    // 更新projectID为创建的项目ID
    projectID = uuid.MustParse(project.ID)
}
```

**功能特点**:
- ✅ 如果项目不存在，自动创建项目
- ✅ 从目标镜像名中提取项目名（如果包含斜杠，第一段是项目名）
- ✅ 如果目标镜像名不包含斜杠，使用项目ID作为项目名
- ✅ 自动创建的项目默认为私有
- ✅ 自动创建的项目无存储限制

### 使用场景

**场景1**: 用户指定项目ID，项目不存在
- 系统自动创建项目
- 使用项目ID作为项目名

**场景2**: 用户指定项目ID和目标镜像名 "my-project/my-image"
- 系统自动创建项目
- 使用 "my-project" 作为项目名

**场景3**: 用户指定项目ID和目标镜像名 "my-image"
- 系统自动创建项目
- 使用项目ID作为项目名

### 总结

- ✅ 项目详情页面已有导入功能（支持从 URL 导入镜像并跟踪任务进度）
- ✅ 自动创建项目功能已实现（导入时若目标项目不存在，会为当前用户自动创建私有项目）

## 3. 日志清理改成15天自动清理一次

### 修改内容

**原配置**: 默认保留90天

**新配置**: 默认保留15天

### 修改文件

1. **`cmd/server/audit_cleanup.go`**:
   ```go
   // 从环境变量读取保留天数，默认15天
   retentionDays := 15
   ```

2. **`src/pkg/audit/audit.go`**:
   ```go
   // CleanupOldLogs 清理旧日志
   // retentionDays: 保留天数，默认15天
   func CleanupOldLogs(retentionDays int) error {
       if retentionDays <= 0 {
           retentionDays = 15 // 默认保留15天
       }
       // ...
   }
   
   func GetOldLogCount(retentionDays int) (int64, error) {
       if retentionDays <= 0 {
           retentionDays = 15
       }
       // ...
   }
   ```

3. **`docs/日志清理机制说明.md`**:
   - ✅ 更新默认保留天数说明：90天 → 15天
   - ✅ 更新配置示例
   - ✅ 更新日志输出示例

### 配置说明

**默认值**: 15天

**环境变量**: `AUDIT_LOG_RETENTION_DAYS`
- 如果不设置，使用默认值15天
- 如果设置，使用设置的值

**示例**:
```bash
# 使用默认值（15天）
# 不设置环境变量

# 自定义保留天数（30天）
export AUDIT_LOG_RETENTION_DAYS=30
```

### 清理频率

**清理间隔**: 默认每24小时执行一次（可通过 `AUDIT_LOG_CLEANUP_INTERVAL_HOURS` 环境变量配置）

**清理逻辑**:
1. 计算截止日期：当前时间 - 15天
2. 删除超过截止日期的日志
3. 记录清理结果

### 总结

- ✅ 默认保留天数已改为15天
- ✅ 所有相关代码和文档已更新
- ✅ 仍支持通过环境变量自定义保留天数
- ✅ 清理频率保持不变（默认每24小时一次）

## 总结

### 完成情况

| 需求 | 状态 | 说明 |
|------|------|------|
| 1. 检查仓库的公开/私有功能 | ✅ | 功能完整，已检查确认 |
| 2. 检查项目详情页面的导入功能，添加自动创建项目功能 | ✅ | 导入功能已存在，并已实现自动创建项目逻辑 |
| 3. 将日志清理改成15天自动清理一次 | ✅ | 已修改默认保留天数为15天 |

### 改进内容

1. **导入功能增强**:
   - ✅ 添加自动创建项目功能
   - ✅ 支持从目标镜像名中提取项目名
   - ✅ 自动创建的项目默认为私有

2. **日志清理优化**:
   - ✅ 默认保留天数从90天改为15天
   - ✅ 减少日志存储空间占用
   - ✅ 仍支持通过环境变量自定义

### 相关文件

**修改的文件**:
1. `src/modules/imageimport/controller/image_import_controller.go` - 添加自动创建项目功能
2. `cmd/server/audit_cleanup.go` - 修改默认保留天数为15天
3. `src/pkg/audit/audit.go` - 修改默认保留天数为15天
4. `docs/日志清理机制说明.md` - 更新文档

**检查的文件**:
1. `src/modules/project/service/project_service.go` - 检查公开/私有功能
2. `web/src/views/project/ProjectDetailView.vue` - 检查导入功能和公开/私有设置
3. `web/src/views/project/ProjectListView.vue` - 检查公开/私有显示

所有功能已检查完成，改进已实施。
