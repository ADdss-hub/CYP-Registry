# CYP-Registry 权限系统完整文档

## 目录

1. [概述](#概述)
2. [权限类型](#权限类型)
3. [权限映射关系](#权限映射关系)
4. [权限检查机制](#权限检查机制)
5. [权限错误码](#权限错误码)
6. [使用指南](#使用指南)
7. [API参考](#api参考)

---

## 概述

CYP-Registry 使用基于 scopes 的权限控制系统，支持 JWT Token 和 Personal Access Token (PAT) 两种认证方式。

### 认证方式

- **JWT Token**：通过登录接口获取，继承用户所有权限
- **PAT Token**：Personal Access Token，可自定义权限范围，适合自动化场景

### 权限控制原则

**选择什么权限就是什么权限**：前端界面选择的权限选项直接对应后端的权限检查，精确控制访问范围。

---

## 权限类型

### 前端权限选项

前端界面提供4个权限选项：

| 权限 | 标识 | 说明 |
|------|------|------|
| 读取 | `read` | 拉取镜像、查看项目信息 |
| 写入 | `write` | 推送镜像、创建/更新项目 |
| 删除 | `delete` | 删除镜像、删除项目 |
| 管理 | `admin` | 访问管理员功能、查看日志 |

### 权限继承规则

```
admin (最高权限，包含所有)
  ├─ delete (包含 write 和 read)
  │   ├─ write (包含 read)
  │   │   └─ read (最低权限)
```

- `admin` scope 包含所有权限
- `delete` scope 包含 `write` 和 `read` 权限
- `write` scope 包含 `read` 权限
- `read` scope 是最低权限

---

## 权限映射关系

### 1. 读取权限 (read)

**前端选择**：勾选"读取"

**后端检查**：
- 拉取镜像 (`pull`) → 需要 `read` scope
- 查看项目信息 → 需要 `read` scope
- 查看镜像列表 → 需要 `read` scope

**权限继承**：
- `write` scope 包含 `read` 权限
- `delete` scope 包含 `read` 权限
- `admin` scope 包含所有权限

### 2. 写入权限 (write)

**前端选择**：勾选"写入"

**后端检查**：
- 推送镜像 (`push`) → 需要 `write` scope
- 创建项目 → 需要 `write` scope
- 更新项目信息 → 需要 `write` scope

**权限继承**：
- `delete` scope 包含 `write` 权限
- `admin` scope 包含所有权限

### 3. 删除权限 (delete)

**前端选择**：勾选"删除"

**后端检查**：
- 删除镜像 → 需要 `delete` scope
- 删除项目 → 需要 `delete` scope
- 删除标签 → 需要 `delete` scope

**权限继承**：
- `admin` scope 包含所有权限

### 4. 管理权限 (admin)

**前端选择**：勾选"管理"

**后端检查**：
- 访问管理员功能 → 需要 `admin` scope
- 查看日志 (`GET /api/v1/admin/logs`) → 需要 `admin` scope
- 用户管理 → 需要 `admin` scope

**权限说明**：
- `admin` scope 包含所有权限（read、write、delete、admin）

---

## 权限检查机制

### AdminRequired 中间件

访问管理员功能时的权限检查流程：

```
1. 验证用户是否为管理员（user.IsAdmin = true）
2. 如果是PAT令牌：
   a. 检查scopes是否包含 admin、admin:* 或 *
   b. 如果不包含 → 返回错误码 30017
3. 如果是JWT令牌：
   → 继承用户所有权限，允许访问
```

### Registry权限检查

在 `checkProjectPermission` 中的权限检查：

```
1. 如果是PAT令牌：
   - pull → 检查 read scope
   - push → 检查 write scope
   - delete → 检查 delete scope
2. 如果是JWT令牌：
   → 继承用户所有权限
3. 检查项目所有权：
   - 公开项目：所有登录用户可 pull
   - 私有项目：仅项目所有者可访问
   - 写操作：仅项目所有者可执行
```

### HasScope 函数

`HasScope(ctx, requiredScope)` 函数用于检查PAT是否拥有指定权限：

- 如果是JWT token → 返回 `true`（继承用户所有权限）
- 如果是PAT token → 检查scopes是否包含所需权限
- 支持权限继承（delete包含write和read，write包含read，admin包含所有）

---

## 权限错误码

### 通用权限错误

| 错误码 | 说明 | HTTP状态码 |
|--------|------|-----------|
| 30001 | 未授权访问 | 401 |
| 30003 | 禁止访问 | 403 |
| 30004 | 权限不足（通用） | 403 |

### PAT权限相关错误码

| 错误码 | 说明 | HTTP状态码 | 触发场景 |
|--------|------|-----------|---------|
| 30014 | PAT缺少读取权限 | 403 | PAT尝试拉取镜像或查看项目，但scopes不包含`read` |
| 30015 | PAT缺少写入权限 | 403 | PAT尝试推送镜像或创建项目，但scopes不包含`write` |
| 30016 | PAT缺少删除权限 | 403 | PAT尝试删除镜像或项目，但scopes不包含`delete` |
| 30017 | PAT缺少管理员权限 | 403 | PAT尝试访问管理员功能（如查看日志），但scopes不包含`admin` |
| 30018 | PAT缺少权限信息 | 403 | PAT的scopes信息不存在 |
| 30019 | PAT权限信息格式错误 | 403 | PAT的scopes格式不正确 |

### 错误响应格式

```json
{
  "code": 30014,
  "message": "PAT令牌缺少读取权限，请在创建令牌时选择'读取'权限",
  "data": null,
  "timestamp": 1704067200,
  "trace_id": "abc12345"
}
```

### Docker Registry API 特殊说明

对于Docker Registry API（`/v2/*`），为了符合Docker Registry规范，权限错误仍返回HTTP 401状态码，但会在日志中记录具体的错误码。

---

## 使用指南

### 创建PAT令牌

#### 1. 创建只读令牌

**前端选择**：只勾选"读取"

**请求**：
```bash
POST /api/v1/users/me/pat
Authorization: Bearer <your_jwt_token>
Content-Type: application/json

{
  "name": "只读令牌",
  "scopes": ["read"],
  "expire_in": 86400
}
```

**可用功能**：
- ✅ 拉取镜像
- ✅ 查看项目信息
- ❌ 推送镜像
- ❌ 删除镜像
- ❌ 访问管理员功能

#### 2. 创建读写令牌

**前端选择**：勾选"读取"和"写入"

**请求**：
```bash
POST /api/v1/users/me/pat
{
  "name": "读写令牌",
  "scopes": ["read", "write"],
  "expire_in": 86400
}
```

**可用功能**：
- ✅ 拉取镜像
- ✅ 推送镜像
- ✅ 查看/创建项目
- ❌ 删除镜像
- ❌ 访问管理员功能

#### 3. 创建完整权限令牌

**前端选择**：勾选"读取"、"写入"、"删除"

**请求**：
```bash
POST /api/v1/users/me/pat
{
  "name": "完整权限令牌",
  "scopes": ["read", "write", "delete"],
  "expire_in": 86400
}
```

**可用功能**：
- ✅ 所有项目操作（拉取、推送、删除）
- ❌ 访问管理员功能

#### 4. 创建管理员令牌

**前端选择**：勾选"管理"（或所有权限）

**请求**：
```bash
POST /api/v1/users/me/pat
{
  "name": "管理员令牌",
  "scopes": ["admin"],
  "expire_in": 0
}
```

**可用功能**：
- ✅ 所有功能
- ✅ 访问管理员功能（查看日志、用户管理等）

### 使用PAT令牌

#### 方式1：Bearer Token

```bash
GET /api/v1/admin/logs
Authorization: Bearer pat_v1_abc123...
```

#### 方式2：Basic Auth（Docker客户端）

```bash
docker login registry.example.com
Username: <any_username>
Password: pat_v1_abc123...
```

### 权限验证示例

#### 示例1：只读令牌访问管理员功能

**PAT scopes**: `["read"]`

**请求**: `GET /api/v1/admin/logs`

**响应**:
```json
{
  "code": 30017,
  "message": "PAT令牌缺少管理员权限，请在创建令牌时选择'管理'权限",
  "data": null
}
```

#### 示例2：管理员令牌访问日志

**PAT scopes**: `["admin"]`

**请求**: `GET /api/v1/admin/logs`

**响应**:
```json
{
  "code": 20000,
  "message": "success",
  "data": {
    "logs": [...],
    "total": 100,
    "page": 1,
    "page_size": 20
  }
}
```

---

## API参考

### 创建PAT

**接口**: `POST /api/v1/users/me/pat`

**请求参数**:
- `name` (string, 必填): 令牌名称
- `scopes` (array, 必填): 权限范围数组，可选值：`read`、`write`、`delete`、`admin`
- `expire_in` (number, 可选): 有效期（秒），0表示使用默认过期时间，-1表示永不过期

**响应**:
```json
{
  "code": 20000,
  "data": {
    "id": "uuid",
    "name": "string",
    "scopes": ["read", "write"],
    "expires_at": "2026-01-01T10:00:00Z",
    "created_at": "2026-01-01T10:00:00Z",
    "token": "pat_v1_实际一次性返回的明文令牌",
    "token_type": "pat"
  }
}
```

### 列出PAT

**接口**: `GET /api/v1/users/me/pat`

**响应**:
```json
{
  "code": 20000,
  "data": [
    {
      "id": "uuid",
      "name": "string",
      "scopes": ["read", "write"],
      "expires_at": "2026-01-01T10:00:00Z",
      "created_at": "2026-01-01T10:00:00Z",
      "last_used_at": "2026-01-15T10:00:00Z"
    }
  ]
}
```

### 撤销PAT

**接口**: `DELETE /api/v1/users/me/pat/{id}`

**响应**:
```json
{
  "code": 20000,
  "message": "PAT已删除"
}
```

### 查看日志（管理员功能）

**接口**: `GET /api/v1/admin/logs`

**权限要求**: 管理员权限 + `admin` scope

**查询参数**:
- `page` (number): 页码，从1开始
- `page_size` (number): 每页数量，默认20，最大100
- `user_id` (string): 用户ID筛选
- `action` (string): 操作类型筛选
- `resource` (string): 资源类型筛选
- `start_time` (string): 开始时间（RFC3339格式）
- `end_time` (string): 结束时间（RFC3339格式）
- `keyword` (string): 关键词搜索

**响应**:
```json
{
  "code": 20000,
  "data": {
    "logs": [...],
    "total": 100,
    "page": 1,
    "page_size": 20,
    "total_page": 5
  }
}
```

---

## 最佳实践

1. **最小权限原则**：只授予必要的权限，避免使用 `admin` scope
2. **定期审查**：定期查看PAT列表，撤销不再使用的令牌
3. **安全存储**：PAT令牌应安全存储，不要提交到代码仓库
4. **设置过期时间**：为PAT设置合理的过期时间，避免长期有效的令牌
5. **权限组合**：根据实际需求选择合适的权限组合

---

## 常见问题

### Q: 为什么管理员创建的PAT默认拥有全部权限？

A: 由于系统中只有管理员用户，为了简化使用和保持向后兼容性，管理员创建的PAT如果未指定scopes，默认拥有全部权限。如果需要限制权限，可以明确指定scopes。

### Q: 如何限制PAT的权限？

A: 在创建PAT时，明确指定scopes。例如，只授予读取权限：`["read"]`

### Q: PAT令牌可以用于哪些场景？

A: PAT令牌可以用于：
- API调用（替代JWT token）
- Docker客户端登录（使用Basic Auth）
- CI/CD流水线自动化
- 第三方系统集成

### Q: 权限错误码有什么作用？

A: 权限错误码帮助前端和客户端：
- 精确识别权限问题
- 提供针对性的错误提示
- 引导用户正确设置权限

---

## 相关文档

- [PAT Scopes 规范](./PAT_SCOPES_规范.md) - 详细的scopes规范定义
- [PAT 使用示例](./PAT_使用示例.md) - 完整的使用示例和场景

---

**最后更新**: 2025年1月
