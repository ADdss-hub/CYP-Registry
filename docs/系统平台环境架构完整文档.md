# CYP-Registry 系统平台、环境、架构完整文档

## 目录

1. [系统平台支持](#1-系统平台支持)
2. [环境要求](#2-环境要求)
3. [架构设计](#3-架构设计)
4. [兼容性说明](#4-兼容性说明)
5. [配置说明](#5-配置说明)
6. [权限系统](#6-权限系统)
7. [清理机制](#7-清理机制)
8. [部署方式](#8-部署方式)
9. [性能优化](#9-性能优化)
10. [安全加固](#10-安全加固)

---

## 1. 系统平台支持

### 1.1 操作系统支持

#### Linux 发行版

| 发行版 | 版本要求 | 支持状态 | 说明 |
|--------|---------|---------|------|
| **Ubuntu** | 18.04+ | ✅ 完全支持 | 标准 GNU 工具集，推荐用于生产环境 |
| **Debian** | 10+ (Buster) | ✅ 完全支持 | 稳定可靠，适合服务器部署 |
| **CentOS** | 7+ | ✅ 完全支持 | SELinux 兼容，容器内通常不需要特殊配置 |
| **RHEL** | 7+ / 8+ / 9+ | ✅ 完全支持 | 企业级支持，SELinux 兼容 |
| **Alpine Linux** | 3.15+ | ✅ 完全支持 | BusyBox 工具集，已优化兼容性，镜像体积小 |
| **openSUSE** | Leap 15.3+ | ✅ 完全支持 | 标准 Linux 工具集 |
| **SUSE Linux Enterprise** | 15 SP3+ | ✅ 完全支持 | 企业级支持 |
| **Fedora** | 35+ | ✅ 完全支持 | 最新特性支持 |
| **Arch Linux** | 最新 | ✅ 完全支持 | 滚动更新，需要手动维护 |

**Linux 特殊说明**:
- ✅ 所有发行版都支持 Docker 和 Podman
- ✅ SELinux 环境（CentOS/RHEL）在容器内通常不需要特殊配置
- ✅ AppArmor 环境（Ubuntu/Debian）默认配置即可
- ✅ 支持 systemd 和非 systemd 初始化系统

#### macOS

| 版本 | 支持状态 | 说明 |
|------|---------|------|
| **macOS 11+ (Big Sur)** | ✅ 完全支持 | 通过 Docker Desktop for Mac |
| **macOS 12+ (Monterey)** | ✅ 完全支持 | 推荐版本 |
| **macOS 13+ (Ventura)** | ✅ 完全支持 | 最新版本 |
| **macOS 14+ (Sonoma)** | ✅ 完全支持 | 最新版本 |

**macOS 特殊说明**:
- ✅ 必须使用 Docker Desktop for Mac（不支持原生 Docker）
- ✅ 支持 Intel 和 Apple Silicon (M1/M2/M3) 芯片
- ✅ 文件系统使用 macOS 原生文件系统（APFS/HFS+）
- ✅ 网络使用 Docker Desktop 的虚拟网络

#### Windows

| 版本 | 支持状态 | 说明 |
|------|---------|------|
| **Windows 10** | ✅ 完全支持 | 通过 Docker Desktop for Windows |
| **Windows 11** | ✅ 完全支持 | 推荐版本 |
| **Windows Server 2019** | ✅ 完全支持 | 服务器版本 |
| **Windows Server 2022** | ✅ 完全支持 | 最新服务器版本 |

**Windows 特殊说明**:
- ✅ 必须使用 Docker Desktop for Windows 或 WSL2
- ✅ WSL2 环境完全支持（推荐）
- ✅ 原生 Windows 环境需要 Docker Desktop
- ✅ 文件系统使用 NTFS，权限自动处理
- ✅ 网络使用 Docker Desktop 的虚拟网络

#### NAS 系统

| NAS 系统 | 支持状态 | 说明 |
|---------|---------|------|
| **群晖 Synology DSM** | ✅ 完全支持 | 通过 Docker 套件 |
| **QNAP QTS** | ✅ 完全支持 | 通过 Container Station |
| **威联通 QNAP** | ✅ 完全支持 | 通过 Container Station |
| **TrueNAS** | ✅ 完全支持 | 通过 Docker/Jails |
| **Unraid** | ✅ 完全支持 | 通过 Docker 插件 |

**NAS 特殊说明**:
- ✅ 所有 NAS 系统都通过 Docker 运行
- ✅ 自动检测挂载点并在需要时使用子目录
- ✅ 权限设置有重试机制，兼容不同的权限模型
- ✅ 日志文件会自动创建并设置正确的权限

### 1.2 CPU 架构支持

| 架构 | 支持状态 | 说明 |
|------|---------|------|
| **AMD64/x86_64** | ✅ 完全支持 | 默认架构，所有功能完整支持 |
| **ARM64 (aarch64)** | ✅ 完全支持 | 需要自行构建镜像，功能完整 |
| **ARMv7** | ⚠️ 部分支持 | 需要自行构建，部分功能可能受限 |
| **ARMv6** | ❌ 不支持 | 性能不足 |
| **PowerPC (ppc64le)** | ⚠️ 实验性 | 需要自行构建，未充分测试 |
| **s390x** | ⚠️ 实验性 | 需要自行构建，未充分测试 |

**架构特殊说明**:
- ✅ AMD64 架构提供预构建镜像
- ⚠️ ARM64 架构需要从源码构建（`docker build`）
- ⚠️ 其他架构需要修改 Dockerfile 并自行构建
- ✅ 所有架构都支持相同的功能集

### 1.3 文件系统支持

| 文件系统 | 支持状态 | 说明 |
|---------|---------|------|
| **ext4** | ✅ 完全支持 | Linux 标准文件系统，推荐 |
| **xfs** | ✅ 完全支持 | RHEL/CentOS 常用，高性能 |
| **btrfs** | ✅ 完全支持 | SUSE/openSUSE 常用，支持快照 |
| **zfs** | ✅ 完全支持 | 高级 NAS 系统，支持压缩和去重 |
| **overlay2** | ✅ 完全支持 | Docker 默认存储驱动 |
| **tmpfs** | ✅ 完全支持 | /run、/tmp 等临时文件系统 |
| **NTFS** | ✅ 完全支持 | Windows 文件系统，权限自动处理 |
| **APFS** | ✅ 完全支持 | macOS 文件系统 |
| **HFS+** | ✅ 完全支持 | macOS 旧版文件系统 |

**文件系统特殊说明**:
- ✅ 所有文件系统都支持完整的读写操作
- ✅ 权限自动处理，无需手动配置
- ✅ 支持大文件（>2GB）
- ✅ 支持符号链接和硬链接

### 1.4 容器运行时支持

| 运行时 | 版本要求 | 支持状态 | 说明 |
|--------|---------|---------|------|
| **Docker** | 20.10+ | ✅ 完全支持 | 推荐，功能最完整 |
| **Docker Engine** | 20.10+ | ✅ 完全支持 | 无 UI 版本 |
| **Podman** | 4.0+ | ✅ 完全支持 | 兼容 Docker CLI，rootless 支持 |
| **containerd** | 1.6+ | ✅ 完全支持 | 通过 Docker/containerd |
| **CRI-O** | 1.24+ | ⚠️ 部分支持 | 需要手动配置，未充分测试 |

**容器运行时特殊说明**:
- ✅ Docker 和 Podman 完全兼容，使用相同的命令
- ✅ 支持 rootless 容器（Podman）
- ✅ 支持容器网络和存储卷
- ✅ 支持健康检查和服务发现

---

## 2. 环境要求

### 2.1 运行时环境

#### Go 语言环境

| 组件 | 版本要求 | 说明 |
|------|---------|------|
| **Go** | 1.24.0+ | 后端开发语言 |
| **GOROOT** | 自动检测 | Go 安装路径 |
| **GOPATH** | 可选 | Go 工作空间（Go 1.11+ 使用 modules） |
| **CGO** | 启用 | 部分依赖需要 CGO |

**Go 环境特殊说明**:
- ✅ 必须使用 Go 1.24.0 或更高版本
- ✅ 支持 Go modules（go.mod）
- ✅ 需要启用 CGO（部分数据库驱动需要）
- ✅ 支持交叉编译（需要设置 CGO_ENABLED=1）

#### Node.js 环境（前端构建）

| 组件 | 版本要求 | 说明 |
|------|---------|------|
| **Node.js** | 18.0+ / 20.0+ | 前端运行时 |
| **npm** | 9.0+ | 包管理器（随 Node.js 安装） |
| **pnpm** | 8.0+ | 可选，更快的包管理器 |
| **yarn** | 1.22+ | 可选，传统包管理器 |

**Node.js 环境特殊说明**:
- ✅ 推荐使用 Node.js 20 LTS
- ✅ 支持 npm、pnpm、yarn 三种包管理器
- ✅ 前端构建需要 Node.js，运行时不需要
- ✅ 支持 ES6+ 语法和 TypeScript

### 2.2 数据库要求

#### PostgreSQL

| 组件 | 版本要求 | 说明 |
|------|---------|------|
| **PostgreSQL** | 12.0+ | 推荐 15.0+ |
| **PostgreSQL 12** | 12.0 - 12.x | ✅ 支持 |
| **PostgreSQL 13** | 13.0 - 13.x | ✅ 支持 |
| **PostgreSQL 14** | 14.0 - 14.x | ✅ 支持 |
| **PostgreSQL 15** | 15.0+ | ✅ 推荐，单镜像模式默认版本 |
| **PostgreSQL 16** | 16.0+ | ✅ 支持 |

**PostgreSQL 特殊说明**:
- ✅ 单镜像模式内置 PostgreSQL 15
- ✅ 支持所有 PostgreSQL 扩展（uuid-ossp、pg_trgm 等）
- ✅ 支持 SSL/TLS 连接
- ✅ 支持连接池和事务
- ✅ 支持 JSON/JSONB 数据类型

#### Redis

| 组件 | 版本要求 | 说明 |
|------|---------|------|
| **Redis** | 6.0+ | 推荐 7.0+ |
| **Redis 6.0** | 6.0 - 6.x | ✅ 支持 |
| **Redis 7.0** | 7.0+ | ✅ 推荐，单镜像模式默认版本 |
| **Redis 7.2** | 7.2+ | ✅ 支持 |

**Redis 特殊说明**:
- ✅ 单镜像模式内置 Redis 7.0
- ✅ 支持密码认证
- ✅ 支持持久化（RDB/AOF）
- ✅ 支持集群模式（需要外部配置）
- ✅ 支持 Sentinel 模式（需要外部配置）

### 2.3 系统资源要求

#### 最低配置

| 资源 | 要求 | 说明 |
|------|------|------|
| **CPU** | 2 核心 | 单镜像模式最低要求 |
| **内存** | 2GB | 单镜像模式最低要求 |
| **磁盘** | 10GB | 系统 + 数据存储 |
| **网络** | 100Mbps | 局域网部署 |

#### 推荐配置

| 资源 | 要求 | 说明 |
|------|------|------|
| **CPU** | 4 核心 | 生产环境推荐 |
| **内存** | 4GB+ | 生产环境推荐 |
| **磁盘** | 50GB+ | 根据镜像数量调整 |
| **网络** | 1Gbps | 生产环境推荐 |

#### 高性能配置

| 资源 | 要求 | 说明 |
|------|------|------|
| **CPU** | 8+ 核心 | 大规模部署 |
| **内存** | 16GB+ | 大规模部署 |
| **磁盘** | 500GB+ | 大规模镜像存储 |
| **网络** | 10Gbps | 高速网络环境 |

**资源特殊说明**:
- ✅ 单镜像模式资源占用更少（共享进程）
- ✅ 支持资源限制（Docker limits）
- ✅ 支持资源监控（Prometheus）
- ✅ 支持自动扩缩容（Kubernetes）

---

## 3. 架构设计

### 3.1 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                     客户端层 (Clients)                        │
├─────────────────────────────────────────────────────────────┤
│  Docker CLI  │  Podman  │  Kubernetes  │  Web Browser      │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    API 网关层 (API Gateway)                   │
├─────────────────────────────────────────────────────────────┤
│  Registry API v2  │  RESTful API  │  WebSocket (SSE)        │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                   应用服务层 (Application Layer)               │
├─────────────────────────────────────────────────────────────┤
│  Registry Controller  │  Project Controller  │  User Controller│
│  Image Import Service │  Webhook Service     │  Admin Service  │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                   业务逻辑层 (Business Layer)                 │
├─────────────────────────────────────────────────────────────┤
│  Authentication  │  Authorization  │  Storage  │  Audit     │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                   数据存储层 (Data Layer)                     │
├─────────────────────────────────────────────────────────────┤
│  PostgreSQL  │  Redis  │  Local Storage  │  MinIO (可选)   │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 前端架构

```
┌─────────────────────────────────────────────────────────────┐
│                   前端应用 (Vue 3 + TypeScript)               │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │  路由层      │  │  状态管理    │  │  API 服务层   │     │
│  │  Vue Router  │  │  Pinia Store │  │  Axios Client│     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
│                                                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │  视图层      │  │  组件层      │  │  工具层      │     │
│  │  Views       │  │  Components │  │  Utils       │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
                    ┌───────────────┐
                    │  Vite Build   │
                    └───────────────┘
                            │
                            ▼
                    ┌───────────────┐
                    │  Static Files │
                    └───────────────┘
```

### 3.3 后端架构

```
┌─────────────────────────────────────────────────────────────┐
│                   后端应用 (Go + Gin)                        │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │  控制器层    │  │  服务层      │  │  数据访问层   │     │
│  │  Controllers │  │  Services    │  │  Repositories│     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
│                                                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │  中间件层    │  │  工具层      │  │  配置层      │     │
│  │  Middleware  │  │  Utils       │  │  Config      │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
└─────────────────────────────────────────────────────────────┘
```

### 3.4 数据流架构

#### 镜像推送流程

```
Docker Client
    │
    ├─► POST /v2/<name>/blobs/uploads/  (InitiateBlobUpload)
    │   └─► 创建上传任务
    │
    ├─► PATCH /v2/<name>/blobs/uploads/<uuid>  (UploadBlobChunk)
    │   └─► 上传 Blob 分片
    │
    ├─► PUT /v2/<name>/blobs/uploads/<uuid>?digest=...  (CompleteBlobUpload)
    │   └─► 完成 Blob 上传
    │
    └─► PUT /v2/<name>/manifests/<reference>  (PutManifest)
        └─► 推送 Manifest
            ├─► 存储到文件系统/MinIO
            ├─► 更新数据库（项目统计）
            ├─► 触发 Webhook
            └─► 记录审计日志
```

#### 镜像拉取流程

```
Docker Client
    │
    ├─► GET /v2/<name>/tags/list  (ListTags)
    │   └─► 查询标签列表
    │
    ├─► GET /v2/<name>/manifests/<reference>  (GetManifest)
    │   └─► 获取 Manifest
    │
    └─► GET /v2/<name>/blobs/<digest>  (GetBlob)
        └─► 获取 Blob 数据
            ├─► 权限检查（公开/私有）
            ├─► 从存储读取
            └─► 记录审计日志
```

### 3.5 部署架构

#### 单镜像模式（All-in-One）

```
┌─────────────────────────────────────────┐
│         Docker Container                │
│  ┌───────────────────────────────────┐  │
│  │  Application Server (Go)          │  │
│  │  ┌─────────────────────────────┐  │  │
│  │  │  PostgreSQL 15 (内置)      │  │  │
│  │  └─────────────────────────────┘  │  │
│  │  ┌─────────────────────────────┐  │  │
│  │  │  Redis 7.0 (内置)           │  │  │
│  │  └─────────────────────────────┘  │  │
│  │  ┌─────────────────────────────┐  │  │
│  │  │  Storage (本地/MinIO)       │  │  │
│  │  └─────────────────────────────┘  │  │
│  └───────────────────────────────────┘  │
└─────────────────────────────────────────┘
```

#### 分离模式（生产环境）

```
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│  Application     │  │  PostgreSQL     │  │  Redis          │
│  Container       │  │  Container       │  │  Container      │
│  (Go Server)     │  │  (Database)     │  │  (Cache)        │
└─────────────────┘  └─────────────────┘  └─────────────────┘
         │                    │                    │
         └────────────────────┴────────────────────┘
                              │
                    ┌─────────────────┐
                    │  Storage        │
                    │  (Local/MinIO)  │
                    └─────────────────┘
```

---

## 4. 兼容性说明

### 4.1 Docker Registry API 兼容性

| API 版本 | 支持状态 | 说明 |
|---------|---------|------|
| **Registry API v2** | ✅ 完全支持 | 严格遵循 OCI Distribution Specification |
| **Manifest v2 Schema 1** | ✅ 支持 | 兼容旧版 Docker |
| **Manifest v2 Schema 2** | ✅ 完全支持 | 推荐格式 |
| **OCI Image Manifest** | ✅ 完全支持 | OCI 标准格式 |
| **OCI Image Index** | ✅ 完全支持 | 多架构镜像 |

**API 兼容性特殊说明**:
- ✅ 完全兼容 Docker CLI、Podman、containerd
- ✅ 支持所有标准 Registry API 端点
- ✅ 支持跨仓库挂载（mount）
- ✅ 支持分片上传和单次上传
- ✅ 支持 Manifest 列表（多架构）

### 4.2 客户端兼容性

#### Docker

| Docker 版本 | 支持状态 | 说明 |
|------------|---------|------|
| **Docker 20.10+** | ✅ 完全支持 | 推荐版本 |
| **Docker 19.03+** | ✅ 支持 | 旧版支持 |
| **Docker 18.09+** | ⚠️ 部分支持 | 部分功能可能受限 |

#### Podman

| Podman 版本 | 支持状态 | 说明 |
|------------|---------|------|
| **Podman 4.0+** | ✅ 完全支持 | 推荐版本 |
| **Podman 3.0+** | ✅ 支持 | 旧版支持 |

#### Kubernetes

| Kubernetes 版本 | 支持状态 | 说明 |
|----------------|---------|------|
| **Kubernetes 1.24+** | ✅ 完全支持 | 推荐版本 |
| **Kubernetes 1.20+** | ✅ 支持 | 旧版支持 |

### 4.3 浏览器兼容性

| 浏览器 | 版本要求 | 支持状态 | 说明 |
|--------|---------|---------|------|
| **Chrome** | 90+ | ✅ 完全支持 | 推荐浏览器 |
| **Firefox** | 88+ | ✅ 完全支持 | 推荐浏览器 |
| **Safari** | 14+ | ✅ 完全支持 | macOS/iOS |
| **Edge** | 90+ | ✅ 完全支持 | Windows |
| **Opera** | 76+ | ✅ 完全支持 | 基于 Chromium |
| **IE 11** | - | ❌ 不支持 | 已停止支持 |

**浏览器特殊说明**:
- ✅ 支持现代浏览器（ES6+）
- ✅ 支持响应式设计（移动端）
- ✅ 支持深色/浅色主题
- ✅ 支持 WebSocket/SSE（实时通知）

### 4.4 网络协议兼容性

| 协议 | 支持状态 | 说明 |
|------|---------|------|
| **HTTP/1.1** | ✅ 完全支持 | 默认协议 |
| **HTTP/2** | ✅ 完全支持 | 通过反向代理 |
| **HTTPS/TLS 1.2+** | ✅ 完全支持 | 通过反向代理 |
| **WebSocket** | ✅ 完全支持 | 实时通知 |
| **SSE (Server-Sent Events)** | ✅ 完全支持 | 实时事件流 |

---

## 5. 配置说明

### 5.1 配置文件结构

系统支持两种配置方式：
1. **环境变量**（推荐，容器化部署）
2. **YAML 配置文件**（传统方式，直接运行）

#### 配置文件位置

- **容器内**: `/app/config.yaml`
- **宿主机**: `./config.yaml`（通过 volume 挂载）

#### 配置文件格式

```yaml
app:
  name: CYP-Registry
  host: 0.0.0.0
  port: 8080
  env: production
  debug: false

database:
  host: 127.0.0.1
  port: 5432
  username: registry
  password: your_password
  name: registry_db
  sslmode: disable
  max_open_conns: 100
  max_idle_conns: 10
  conn_max_lifetime: 3600

redis:
  host: 127.0.0.1
  port: 6379
  password: ""
  db: 0
  pool_size: 10
  min_idle_conns: 5
  key_prefix: "cyp_registry:"

auth:
  jwt:
    access_token_expire: 3600
    refresh_token_expire: 604800
    secret: your_jwt_secret
  pat:
    prefix: "cyp_pat_"
    expire: 2592000
  bcrypt_cost: 10

storage:
  type: local  # 或 minio
  local:
    root_path: /data/storage
  minio:
    endpoint: localhost:9000
    access_key: minioadmin
    secret_key: minioadmin
    bucket: registry
    use_ssl: false

registry:
  storage_path: /data/storage

security:
  cors:
    enabled: true
    allowed_origins:
      - "*"
    allowed_methods:
      - GET
      - POST
      - PUT
      - DELETE
      - PATCH
    allowed_headers:
      - "*"
  rate_limit:
    enabled: true
    requests_per_minute: 60
  brute_force:
    enabled: true
    max_attempts: 5
    lockout_duration: 300

logging:
  level: info
  format: json
  output: stdout
  file:
    enabled: true
    path: /app/logs/app.log
    max_size: 100
    max_backups: 10
    max_age: 30
    compress: true

scanner:
  enabled: false

webhook:
  enabled: true
  timeout: 30
```

### 5.2 环境变量配置

#### 应用配置

| 环境变量 | 说明 | 默认值 | 示例 |
|---------|------|--------|------|
| `APP_NAME` | 应用名称 | `CYP-Registry` | `CYP-Registry` |
| `APP_ENV` | 运行环境 | `development` | `production` |
| `APP_HOST` | 监听地址 | `0.0.0.0` | `0.0.0.0` |
| `APP_PORT` | 监听端口 | `8080` | `8080` |
| `APP_DEBUG` | 调试模式 | `false` | `true` |

#### 数据库配置

| 环境变量 | 说明 | 默认值 | 示例 |
|---------|------|--------|------|
| `DB_HOST` | 数据库主机 | `127.0.0.1` | `localhost` |
| `DB_PORT` | 数据库端口 | `5432` | `5432` |
| `DB_USER` | 数据库用户 | `registry` | `registry` |
| `DB_PASSWORD` | 数据库密码 | - | `your_password` |
| `DB_NAME` | 数据库名称 | `registry_db` | `registry_db` |
| `DB_SSLMODE` | SSL 模式 | `disable` | `require` |
| `DB_MAX_OPEN_CONNS` | 最大连接数 | `100` | `100` |
| `DB_MAX_IDLE_CONNS` | 最大空闲连接 | `10` | `10` |
| `DB_CONN_MAX_LIFETIME` | 连接最大存活时间（秒） | `3600` | `3600` |

#### Redis 配置

| 环境变量 | 说明 | 默认值 | 示例 |
|---------|------|--------|------|
| `REDIS_HOST` | Redis 主机 | `127.0.0.1` | `localhost` |
| `REDIS_PORT` | Redis 端口 | `6379` | `6379` |
| `REDIS_PASSWORD` | Redis 密码 | - | `your_password` |
| `REDIS_DB` | Redis 数据库编号 | `0` | `0` |
| `REDIS_POOL_SIZE` | 连接池大小 | `10` | `10` |
| `REDIS_MIN_IDLE_CONNS` | 最小空闲连接 | `5` | `5` |
| `REDIS_KEY_PREFIX` | 键前缀 | `cyp_registry:` | `cyp_registry:` |

#### 认证配置

| 环境变量 | 说明 | 默认值 | 示例 |
|---------|------|--------|------|
| `JWT_SECRET` | JWT 密钥 | - | `your_jwt_secret` |
| `JWT_ACCESS_TOKEN_EXPIRE` | Access Token 过期时间（秒） | `3600` | `3600` |
| `JWT_REFRESH_TOKEN_EXPIRE` | Refresh Token 过期时间（秒） | `604800` | `604800` |
| `PAT_PREFIX` | PAT 前缀 | `cyp_pat_` | `cyp_pat_` |
| `PAT_EXPIRE` | PAT 过期时间（秒） | `2592000` | `2592000` |
| `BCRYPT_COST` | Bcrypt 成本 | `10` | `10` |

#### 存储配置

| 环境变量 | 说明 | 默认值 | 示例 |
|---------|------|--------|------|
| `STORAGE_TYPE` | 存储类型 | `local` | `local` 或 `minio` |
| `STORAGE_LOCAL_ROOT_PATH` | 本地存储根路径 | `/data/storage` | `/data/storage` |
| `STORAGE_MINIO_ENDPOINT` | MinIO 端点 | - | `localhost:9000` |
| `STORAGE_MINIO_ACCESS_KEY` | MinIO 访问密钥 | - | `minioadmin` |
| `STORAGE_MINIO_SECRET_KEY` | MinIO 密钥 | - | `minioadmin` |
| `STORAGE_MINIO_BUCKET` | MinIO 存储桶 | - | `registry` |
| `STORAGE_MINIO_USE_SSL` | MinIO 使用 SSL | `false` | `true` |

#### 安全配置

| 环境变量 | 说明 | 默认值 | 示例 |
|---------|------|--------|------|
| `CORS_ENABLED` | 启用 CORS | `true` | `true` |
| `CORS_ALLOWED_ORIGINS` | 允许的来源 | `*` | `https://example.com` |
| `RATE_LIMIT_ENABLED` | 启用速率限制 | `true` | `true` |
| `RATE_LIMIT_REQUESTS_PER_MINUTE` | 每分钟请求数 | `60` | `60` |
| `BRUTE_FORCE_ENABLED` | 启用暴力破解防护 | `true` | `true` |
| `BRUTE_FORCE_MAX_ATTEMPTS` | 最大尝试次数 | `5` | `5` |
| `BRUTE_FORCE_LOCKOUT_DURATION` | 锁定持续时间（秒） | `300` | `300` |

#### 日志配置

| 环境变量 | 说明 | 默认值 | 示例 |
|---------|------|--------|------|
| `LOG_LEVEL` | 日志级别 | `info` | `debug`、`info`、`warn`、`error` |
| `LOG_FORMAT` | 日志格式 | `json` | `json` 或 `text` |
| `LOG_OUTPUT` | 日志输出 | `stdout` | `stdout` 或 `file` |
| `LOG_FILE_PATH` | 日志文件路径 | `/app/logs/app.log` | `/app/logs/app.log` |
| `LOG_FILE_MAX_SIZE` | 日志文件最大大小（MB） | `100` | `100` |
| `LOG_FILE_MAX_BACKUPS` | 最大备份数 | `10` | `10` |
| `LOG_FILE_MAX_AGE` | 最大保留天数 | `30` | `30` |
| `LOG_FILE_COMPRESS` | 压缩旧日志 | `true` | `true` |

#### 审计日志清理配置

| 环境变量 | 说明 | 默认值 | 示例 |
|---------|------|--------|------|
| `AUDIT_LOG_RETENTION_DAYS` | 日志保留天数 | `15` | `30` |
| `AUDIT_LOG_CLEANUP_INTERVAL_HOURS` | 清理间隔（小时） | `24` | `12` |

### 5.3 配置优先级

1. **环境变量**（最高优先级）
2. **YAML 配置文件**
3. **默认值**（最低优先级）

### 5.4 配置验证

系统启动时会自动验证配置：
- ✅ 检查必需配置项
- ✅ 验证配置格式
- ✅ 检查数据库连接
- ✅ 检查 Redis 连接
- ✅ 检查存储路径权限

---

## 6. 权限系统

### 6.1 认证方式

#### JWT Token

| 特性 | 说明 |
|------|------|
| **类型** | JSON Web Token |
| **算法** | HS256 |
| **Access Token 过期时间** | 默认 1 小时（可配置） |
| **Refresh Token 过期时间** | 默认 7 天（可配置） |
| **自动刷新** | 支持自动刷新机制 |
| **使用场景** | Web 界面登录 |

#### Personal Access Token (PAT)

| 特性 | 说明 |
|------|------|
| **类型** | 自定义 Token |
| **格式** | `cyp_pat_<uuid>` |
| **过期时间** | 可配置（默认 30 天） |
| **作用域** | 细粒度权限控制 |
| **使用场景** | API 调用、CI/CD |

#### Robot Account（未来支持）

| 特性 | 说明 |
|------|------|
| **类型** | 机器人账号 |
| **用途** | 自动化场景 |
| **状态** | 规划中 |

### 6.2 权限模型

#### RBAC (Role-Based Access Control)

| 角色 | 权限 | 说明 |
|------|------|------|
| **管理员 (admin)** | 所有权限 | 系统管理员 |
| **项目所有者 (owner)** | 项目所有权限 | 项目创建者 |
| **项目成员 (member)** | 项目读写权限 | 项目成员 |
| **访客 (guest)** | 项目只读权限 | 访客用户 |

#### PAT 作用域

| 作用域 | 权限 | 说明 |
|--------|------|------|
| `read` | 读取权限 | 拉取镜像、查看项目 |
| `write` | 写入权限 | 推送镜像、创建项目 |
| `delete` | 删除权限 | 删除镜像、删除项目 |
| `admin` | 管理员权限 | 所有权限 |
| `admin:*` | 管理员所有权限 | 等同于 `admin` |
| `*` | 所有权限 | 完全访问 |

**作用域继承规则**:
- `admin` 包含所有权限
- `write` 包含 `read`
- `delete` 不包含 `write`（需要单独授予）

### 6.3 项目权限

#### 公开/私有项目

| 类型 | 匿名用户 | 认证用户 | 项目成员 | 项目所有者 |
|------|---------|---------|---------|-----------|
| **公开项目** | ✅ 拉取 | ✅ 拉取 | ✅ 拉取 | ✅ 所有操作 |
| **私有项目** | ❌ 无权限 | ❌ 无权限 | ✅ 拉取 | ✅ 所有操作 |

#### 权限检查流程

```
请求
  │
  ├─► 检查认证（JWT/PAT）
  │   └─► 未认证 → 401 Unauthorized
  │
  ├─► 检查项目是否存在
  │   └─► 不存在 → 404 Not Found
  │
  ├─► 检查项目公开/私有
  │   ├─► 公开项目 + pull 操作 → ✅ 允许
  │   └─► 私有项目 → 继续检查
  │
  ├─► 检查用户角色
  │   ├─► 管理员 → ✅ 允许
  │   ├─► 项目所有者 → ✅ 允许
  │   └─► 项目成员 → 检查操作类型
  │
  └─► 检查 PAT 作用域（如果是 PAT）
      ├─► 有对应作用域 → ✅ 允许
      └─► 无对应作用域 → 403 Forbidden
```

### 6.4 权限错误码

| 错误码 | HTTP 状态码 | 说明 |
|--------|------------|------|
| `30001` | 401 | 未授权（需要登录） |
| `30002` | 401 | Token 无效或过期 |
| `30003` | 403 | 禁止访问（权限不足） |
| `30004` | 403 | PAT 权限不足（缺少作用域） |
| `30005` | 403 | 项目私有，需要认证 |
| `30006` | 403 | 非项目成员，无访问权限 |

---

## 7. 清理机制

### 7.1 审计日志清理

#### 自动清理

| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| **保留天数** | 15 天 | 超过此天数的日志自动删除 |
| **清理间隔** | 24 小时 | 每 24 小时执行一次清理 |
| **首次延迟** | 下一个整点小时 | 等待到下一个整点小时执行 |

#### 清理策略

```go
// 清理逻辑
1. 计算截止日期：当前时间 - 保留天数
2. 查询超过截止日期的日志数量
3. 删除超过截止日期的日志
4. 记录清理结果
```

#### 配置方式

**环境变量**:
```bash
# 保留 30 天日志
export AUDIT_LOG_RETENTION_DAYS=30

# 每 12 小时清理一次
export AUDIT_LOG_CLEANUP_INTERVAL_HOURS=12
```

**手动清理**:
```sql
-- 删除 15 天前的日志
DELETE FROM registry_audit_logs 
WHERE created_at < NOW() - INTERVAL '15 days';
```

### 7.2 应用日志清理

#### 日志轮转

| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| **最大文件大小** | 100 MB | 单个日志文件最大大小 |
| **最大备份数** | 10 | 保留的备份文件数量 |
| **最大保留天数** | 30 天 | 日志文件保留天数 |
| **压缩** | 启用 | 自动压缩旧日志 |

#### 日志轮转策略

```
app.log          (当前日志)
app.log.1        (1 天前)
app.log.2        (2 天前)
app.log.3.gz     (3 天前，已压缩)
...
app.log.30.gz    (30 天前，已压缩)
```

### 7.3 镜像存储清理

#### 手动清理

系统不自动清理镜像存储，需要手动管理：

```bash
# 查看存储使用情况
docker exec cyp-registry du -sh /data/storage

# 清理未使用的镜像层（需要 Docker 支持）
docker system prune -a
```

#### 存储配额管理

| 配置项 | 说明 |
|--------|------|
| **项目存储配额** | 每个项目可设置存储配额 |
| **配额检查** | 推送镜像时检查配额 |
| **配额超限** | 超过配额时拒绝推送 |

### 7.4 数据库清理

#### 软删除

系统使用软删除机制：
- ✅ 删除的项目和用户不会真正删除
- ✅ 使用 `deleted_at` 字段标记
- ✅ 可以恢复已删除的数据

#### 手动清理

```sql
-- 清理已删除的项目（30 天前删除的）
DELETE FROM registry_projects 
WHERE deleted_at IS NOT NULL 
  AND deleted_at < NOW() - INTERVAL '30 days';

-- 清理已删除的用户（30 天前删除的）
DELETE FROM registry_users 
WHERE deleted_at IS NOT NULL 
  AND deleted_at < NOW() - INTERVAL '30 days';
```

---

## 8. 部署方式

### 8.1 Docker Compose 部署

#### 单镜像模式

```yaml
version: '3.8'

services:
  cyp-registry:
    image: ghcr.io/addss-hub/cyp-registry:v1.0.8
    container_name: cyp-registry
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      - APP_ENV=production
      - DB_PASSWORD=${DB_PASSWORD}
      - JWT_SECRET=${JWT_SECRET}
    volumes:
      - pg_data:/var/lib/postgresql/data
      - redis_data:/data/redis
      - storage_data:/data/storage
      - logs_data:/app/logs

volumes:
  pg_data:
  redis_data:
  storage_data:
  logs_data:
```

#### 分离模式

```yaml
version: '3.8'

services:
  app:
    image: ghcr.io/addss-hub/cyp-registry:v1.0.8
    depends_on:
      - postgres
      - redis
    environment:
      - DB_HOST=postgres
      - REDIS_HOST=redis

  postgres:
    image: postgres:15
    environment:
      - POSTGRES_DB=registry_db
      - POSTGRES_USER=registry
      - POSTGRES_PASSWORD=${DB_PASSWORD}

  redis:
    image: redis:7
    command: redis-server --requirepass ${REDIS_PASSWORD}
```

### 8.2 Kubernetes 部署

#### Deployment

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cyp-registry
spec:
  replicas: 2
  selector:
    matchLabels:
      app: cyp-registry
  template:
    metadata:
      labels:
        app: cyp-registry
    spec:
      containers:
      - name: cyp-registry
        image: ghcr.io/addss-hub/cyp-registry:v1.0.8
        ports:
        - containerPort: 8080
        env:
        - name: APP_ENV
          value: "production"
        - name: DB_HOST
          value: "postgres-service"
        - name: REDIS_HOST
          value: "redis-service"
```

#### Service

```yaml
apiVersion: v1
kind: Service
metadata:
  name: cyp-registry-service
spec:
  selector:
    app: cyp-registry
  ports:
  - port: 80
    targetPort: 8080
  type: LoadBalancer
```

### 8.3 云平台部署

#### AWS ECS

- ✅ 支持 ECS Fargate
- ✅ 支持 ECS EC2
- ✅ 支持 Application Load Balancer
- ✅ 支持 RDS PostgreSQL
- ✅ 支持 ElastiCache Redis

#### Azure Container Instances

- ✅ 支持 ACI
- ✅ 支持 Azure Database for PostgreSQL
- ✅ 支持 Azure Cache for Redis

#### GCP Cloud Run

- ✅ 支持 Cloud Run
- ✅ 支持 Cloud SQL PostgreSQL
- ✅ 支持 Memorystore Redis

---

## 9. 性能优化

### 9.1 数据库优化

#### 连接池配置

```yaml
database:
  max_open_conns: 100      # 最大连接数
  max_idle_conns: 10       # 最大空闲连接
  conn_max_lifetime: 3600  # 连接最大存活时间（秒）
```

#### 索引优化

系统自动创建以下索引：
- ✅ 用户表：`email`、`username`
- ✅ 项目表：`name`、`owner_id`
- ✅ 审计日志表：`created_at`、`user_id`、`action`

### 9.2 Redis 优化

#### 连接池配置

```yaml
redis:
  pool_size: 10           # 连接池大小
  min_idle_conns: 5        # 最小空闲连接
```

#### 缓存策略

- ✅ JWT Token 缓存
- ✅ 用户信息缓存
- ✅ 项目信息缓存
- ✅ 速率限制计数

### 9.3 存储优化

#### 本地存储

- ✅ 使用文件系统直接存储
- ✅ 支持符号链接
- ✅ 支持硬链接（去重）

#### MinIO 存储

- ✅ 支持多节点部署
- ✅ 支持纠删码（Erasure Coding）
- ✅ 支持压缩
- ✅ 支持生命周期管理

### 9.4 网络优化

#### HTTP/2 支持

通过反向代理启用 HTTP/2：
```nginx
server {
    listen 443 ssl http2;
    # ...
}
```

#### 压缩支持

- ✅ Gzip 压缩（通过反向代理）
- ✅ Brotli 压缩（通过反向代理）

---

## 10. 安全加固

### 10.1 认证安全

#### 密码策略

- ✅ Bcrypt 加密（成本 10）
- ✅ 最小长度要求
- ✅ 密码复杂度要求（可选）

#### Token 安全

- ✅ JWT Secret 必须设置强随机值
- ✅ Token 过期时间合理设置
- ✅ 支持 Token 撤销（PAT）

### 10.2 网络安全

#### HTTPS/TLS

- ✅ 通过反向代理启用 HTTPS
- ✅ 支持 TLS 1.2+
- ✅ 支持证书自动续期（Let's Encrypt）

#### CORS 配置

```yaml
security:
  cors:
    enabled: true
    allowed_origins:
      - "https://your-domain.com"
    allowed_methods:
      - GET
      - POST
      - PUT
      - DELETE
```

### 10.3 速率限制

#### 配置

```yaml
security:
  rate_limit:
    enabled: true
    requests_per_minute: 60
```

#### 防护范围

- ✅ API 请求限制
- ✅ 登录尝试限制
- ✅ 注册请求限制

### 10.4 暴力破解防护

#### 配置

```yaml
security:
  brute_force:
    enabled: true
    max_attempts: 5
    lockout_duration: 300
```

#### 防护机制

- ✅ 登录失败次数限制
- ✅ 自动锁定账户
- ✅ 解锁时间可配置

---

## 总结

### 平台支持

- ✅ **操作系统**: Linux、macOS、Windows、NAS 系统
- ✅ **CPU 架构**: AMD64、ARM64、ARMv7
- ✅ **容器运行时**: Docker、Podman、containerd
- ✅ **文件系统**: ext4、xfs、btrfs、zfs、NTFS、APFS

### 环境要求

- ✅ **Go**: 1.24.0+
- ✅ **Node.js**: 18.0+ / 20.0+
- ✅ **PostgreSQL**: 12.0+（推荐 15.0+）
- ✅ **Redis**: 6.0+（推荐 7.0+）

### 架构设计

- ✅ **前后端分离**: Vue 3 + Go
- ✅ **单镜像模式**: All-in-One 部署
- ✅ **分离模式**: 生产环境推荐
- ✅ **微服务就绪**: 支持 Kubernetes

### 兼容性

- ✅ **Docker Registry API v2**: 完全兼容
- ✅ **客户端**: Docker、Podman、Kubernetes
- ✅ **浏览器**: Chrome、Firefox、Safari、Edge

### 配置管理

- ✅ **环境变量**: 推荐方式
- ✅ **YAML 配置文件**: 传统方式
- ✅ **配置验证**: 自动验证
- ✅ **配置优先级**: 环境变量 > 配置文件 > 默认值

### 权限系统

- ✅ **认证方式**: JWT、PAT
- ✅ **权限模型**: RBAC
- ✅ **项目权限**: 公开/私有
- ✅ **细粒度控制**: PAT 作用域

### 清理机制

- ✅ **审计日志**: 自动清理（默认 15 天）
- ✅ **应用日志**: 自动轮转
- ✅ **镜像存储**: 手动管理
- ✅ **数据库**: 软删除机制

系统设计完善，支持多种平台和环境，配置灵活，权限控制精细，清理机制完善，适合各种部署场景。
