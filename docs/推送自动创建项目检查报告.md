# 推送自动创建项目功能检查报告

## 功能概述

系统支持在推送镜像时自动创建项目。当用户推送镜像到一个不存在的项目时，系统会自动创建该项目，并将推送用户设置为项目所有者。

## 当前实现

### 1. 权限检查逻辑 (`checkProjectPermission`)

**位置**: `src/modules/registry/controller/registry_controller.go:312-410`

**当前流程**:
1. 解析用户ID
2. 获取项目信息 (`GetProjectByName`)
3. **如果项目不存在** → 直接返回 `true`（允许访问）⚠️
4. 如果项目存在 → 检查PAT权限
5. 检查项目所有权和公开性

**问题**: 当项目不存在时，会跳过PAT权限检查，直接允许访问。这意味着即使PAT token没有`write`权限，也可以推送镜像到不存在的项目。

### 2. 自动创建项目逻辑 (`PutManifest`)

**位置**: `src/modules/registry/controller/registry_controller.go:755-766`

**实现**:
```go
// 如果项目不存在，则以 push 用户作为 owner 自动创建
p, getErr := c.projectSvc.GetProjectByName(ctx.Request.Context(), projectSlug)
if getErr != nil {
    p, _ = c.projectSvc.CreateProject(
        ctx.Request.Context(),
        projectSlug,
        fmt.Sprintf("Auto created from image push (%s)", reference),
        ownerID,
        false,  // 默认私有项目
        0,      // 使用默认配额
    )
}
```

**特点**:
- ✅ 自动创建项目
- ✅ 使用推送用户作为owner
- ✅ 默认创建为私有项目
- ✅ 使用默认存储配额

## 发现的问题

### 问题1: PAT权限检查顺序错误

**当前逻辑**:
```
1. 检查项目是否存在
2. 如果不存在 → 直接允许（跳过PAT权限检查）
3. 如果存在 → 检查PAT权限
```

**问题**: PAT权限检查应该在项目存在性检查之前，或者至少对于push操作，应该先检查write权限。

**影响**: 
- 没有`write`权限的PAT token可以推送镜像到不存在的项目
- 违反了"选择什么权限就是什么权限"的原则

### 问题2: 权限检查不完整

对于push操作，应该：
1. 先检查PAT的write权限（如果使用PAT token）
2. 如果项目不存在，允许自动创建（前提是有write权限）
3. 如果项目存在，检查项目所有权

## 建议的修复方案

### 方案1: 先检查权限，再检查项目存在性（推荐）

**修改 `checkProjectPermission` 函数**:

```go
func (c *RegistryController) checkProjectPermission(ctx *gin.Context, project, permission string) (bool, int, string) {
    // ... 解析用户ID ...

    // 1) 先检查PAT权限（如果使用PAT token）
    tokenTypeVal, tokenTypeExists := ctx.Get(middleware.ContextKeyTokenType)
    if tokenTypeExists {
        if tokenType, ok := tokenTypeVal.(string); ok && tokenType == "pat" {
            var hasPermission bool
            var errorCode int
            var errorMessage string
            switch permission {
            case "pull":
                hasPermission, errorCode, errorMessage = middleware.HasScope(ctx, "read")
            case "push":
                hasPermission, errorCode, errorMessage = middleware.HasScope(ctx, "write")
            case "delete":
                hasPermission, errorCode, errorMessage = middleware.HasScope(ctx, "delete")
            }
            if !hasPermission {
                return false, errorCode, errorMessage
            }
        }
    }

    // 2) 检查项目是否存在
    p, err := c.projectSvc.GetProjectByName(ctx.Request.Context(), projectSlug)
    if err != nil || p == nil {
        // 项目不存在
        if permission == "push" {
            // push操作：如果用户有write权限（已通过PAT检查或使用JWT），允许自动创建
            return true, 0, ""
        } else if permission == "pull" {
            // pull操作：项目不存在，无法拉取
            return false, response.CodeNotFound, "项目不存在"
        }
        // 其他操作：项目不存在，拒绝
        return false, response.CodeNotFound, "项目不存在"
    }

    // 3) 项目存在，检查项目权限
    // ... 现有的权限检查逻辑 ...
}
```

### 方案2: 在PutManifest中先检查权限

在`PutManifest`函数中，先检查write权限，然后再检查项目是否存在。

## 测试场景

### 场景1: JWT Token推送新项目
- ✅ 应该成功
- ✅ 自动创建项目
- ✅ 用户成为项目所有者

### 场景2: PAT Token（有write权限）推送新项目
- ✅ 应该成功
- ✅ 自动创建项目
- ✅ 用户成为项目所有者

### 场景3: PAT Token（无write权限）推送新项目
- ❌ 当前实现：可能成功（bug）
- ✅ 修复后：应该失败，返回30015错误码

### 场景4: PAT Token（有write权限）推送到已存在项目（非所有者）
- ❌ 应该失败：权限不足，仅项目所有者可以执行此操作

### 场景5: PAT Token（无write权限）推送到已存在项目
- ❌ 应该失败：PAT缺少写入权限

## 修复方案

### 已修复的问题

**修复内容**: 调整权限检查顺序，将PAT权限检查移到项目存在性检查之前。

**修复后的逻辑**:
1. ✅ 先检查PAT权限（如果使用PAT token）
   - pull → 检查read权限
   - push → 检查write权限
   - delete → 检查delete权限
2. ✅ 如果项目不存在：
   - push操作：只有通过权限检查的用户才能自动创建项目
   - pull操作：返回404（项目不存在）
3. ✅ 如果项目存在：检查项目所有权和公开性

**修复效果**:
- ✅ PAT token必须拥有write权限才能推送镜像到新项目
- ✅ 严格执行"选择什么权限就是什么权限"的原则
- ✅ 自动创建项目功能仍然正常工作

## 总结

**当前状态**: 
- ✅ 支持自动创建项目
- ✅ PAT权限检查已修复（先检查权限，再检查项目存在性）
- ✅ 确保"选择什么权限就是什么权限"的原则得到严格执行

**修复后的行为**:
- JWT Token推送新项目 → ✅ 自动创建（继承用户所有权限）
- PAT Token（有write权限）推送新项目 → ✅ 自动创建
- PAT Token（无write权限）推送新项目 → ❌ 拒绝，返回30015错误码
