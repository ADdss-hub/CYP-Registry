# CYP-Registry 系统平台环境架构完整文档 - 补充说明

## 快速参考

### 平台支持矩阵

| 平台 | 操作系统 | CPU架构 | 容器运行时 | 支持状态 |
|------|---------|--------|-----------|---------|
| **Linux 服务器** | Ubuntu 20.04+ | AMD64 | Docker/Podman | ✅ 完全支持 |
| **Linux 服务器** | CentOS 7+ | AMD64 | Docker/Podman | ✅ 完全支持 |
| **Linux 服务器** | Alpine 3.15+ | AMD64 | Docker | ✅ 完全支持 |
| **macOS 开发** | macOS 12+ | Intel/Apple Silicon | Docker Desktop | ✅ 完全支持 |
| **Windows 开发** | Windows 10/11 | AMD64 | Docker Desktop/WSL2 | ✅ 完全支持 |
| **NAS 系统** | Synology/QNAP | AMD64/ARM64 | Docker | ✅ 完全支持 |
| **ARM 设备** | Linux | ARM64 | Docker | ⚠️ 需自行构建 |

### 环境要求快速检查

```bash
# 检查 Go 版本
go version  # 需要 1.24.0+

# 检查 Node.js 版本
node --version  # 需要 18.0+ 或 20.0+

# 检查 Docker 版本
docker --version  # 需要 20.10+

# 检查磁盘空间
df -h  # 需要至少 10GB 可用空间

# 检查内存
free -h  # 需要至少 2GB 可用内存
```

### 配置快速参考

#### 最小配置（开发环境）

```bash
# .env 文件
APP_ENV=development
APP_PORT=8080
DB_PASSWORD=dev_password
JWT_SECRET=dev_secret
```

#### 生产配置（推荐）

```bash
# .env 文件
APP_ENV=production
APP_PORT=8080
DB_PASSWORD=<强随机密码，32+字符>
JWT_SECRET=<强随机密钥，32+字符>
REDIS_PASSWORD=<强随机密码，可选>
AUDIT_LOG_RETENTION_DAYS=15
```

### 部署命令快速参考

#### Docker Compose（单镜像模式）

```bash
# 启动
docker compose -f docker-compose.single.yml up -d --build

# 停止
docker compose -f docker-compose.single.yml down

# 查看日志
docker compose -f docker-compose.single.yml logs -f

# 重启
docker compose -f docker-compose.single.yml restart
```

#### Docker 直接运行

```bash
# 启动
docker run -d \
  --name cyp-registry \
  -p 8080:8080 \
  -v cyp-registry-data:/data \
  ghcr.io/addss-hub/cyp-registry:v1.0.8

# 停止
docker stop cyp-registry

# 删除
docker rm cyp-registry
```

### 权限快速参考

#### JWT Token 使用

```bash
# 登录获取 Token
curl -X POST http://localhost:8080/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"password"}'

# 使用 Token 访问 API
curl -X GET http://localhost:8080/api/v1/users/me \
  -H "Authorization: Bearer <your-token>"
```

#### PAT Token 使用

```bash
# 创建 PAT（需要先登录获取 JWT）
curl -X POST http://localhost:8080/api/v1/users/me/pat \
  -H "Authorization: Bearer <jwt-token>" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "ci-cd-token",
    "scopes": ["read", "write"],
    "expires_in": 2592000
  }'

# 使用 PAT 访问 API
curl -X GET http://localhost:8080/api/v1/projects \
  -H "Authorization: Bearer <pat-token>"
```

### 清理操作快速参考

#### 审计日志清理

```bash
# 查看当前日志数量
docker exec cyp-registry psql -U registry -d registry_db \
  -c "SELECT COUNT(*) FROM registry_audit_logs;"

# 手动清理（15天前）
docker exec cyp-registry psql -U registry -d registry_db \
  -c "DELETE FROM registry_audit_logs WHERE created_at < NOW() - INTERVAL '15 days';"
```

#### 应用日志清理

```bash
# 查看日志文件大小
docker exec cyp-registry du -sh /app/logs

# 清理旧日志（保留最近10个文件）
docker exec cyp-registry sh -c "cd /app/logs && ls -t | tail -n +11 | xargs rm -f"
```

#### 镜像存储清理

```bash
# 查看存储使用情况
docker exec cyp-registry du -sh /data/storage

# 清理未使用的镜像（需要 Docker 支持）
docker system prune -a
```

### 故障排查快速参考

#### 常见问题

1. **容器无法启动**
   ```bash
   # 查看容器日志
   docker logs cyp-registry
   
   # 检查端口占用
   netstat -tuln | grep 8080
   
   # 检查数据卷权限
   docker exec cyp-registry ls -la /data
   ```

2. **数据库连接失败**
   ```bash
   # 检查数据库状态
   docker exec cyp-registry pg_isready -U registry
   
   # 检查数据库配置
   docker exec cyp-registry env | grep DB_
   ```

3. **Redis 连接失败**
   ```bash
   # 检查 Redis 状态
   docker exec cyp-registry redis-cli ping
   
   # 检查 Redis 配置
   docker exec cyp-registry env | grep REDIS_
   ```

4. **权限问题**
   ```bash
   # 检查文件权限
   docker exec cyp-registry ls -la /data/storage
   
   # 修复权限（如果需要）
   docker exec cyp-registry chown -R 1000:1000 /data/storage
   ```

### 性能调优快速参考

#### 数据库优化

```yaml
# config.yaml
database:
  max_open_conns: 100      # 根据并发调整
  max_idle_conns: 10      # 保持连接池
  conn_max_lifetime: 3600  # 1小时
```

#### Redis 优化

```yaml
# config.yaml
redis:
  pool_size: 10           # 连接池大小
  min_idle_conns: 5       # 最小空闲连接
```

#### 应用优化

```yaml
# config.yaml
app:
  debug: false            # 生产环境关闭调试
logging:
  level: info            # 生产环境使用 info
  file:
    max_size: 100         # 日志文件大小（MB）
    max_backups: 10       # 保留备份数
```

### 安全加固快速参考

#### 必需的安全配置

```bash
# 1. 设置强密码
export DB_PASSWORD=$(openssl rand -base64 32)
export JWT_SECRET=$(openssl rand -base64 32)
export REDIS_PASSWORD=$(openssl rand -base64 32)

# 2. 启用 HTTPS（通过反向代理）
# 使用 Nginx/Caddy 配置 SSL

# 3. 配置防火墙
# 只开放必要端口（80、443）

# 4. 定期更新镜像
docker pull ghcr.io/addss-hub/cyp-registry:v1.0.8
```

#### 安全检查清单

- [ ] 设置强密码（DB_PASSWORD、JWT_SECRET）
- [ ] 启用 HTTPS
- [ ] 配置防火墙规则
- [ ] 启用速率限制
- [ ] 启用暴力破解防护
- [ ] 配置 CORS（限制来源）
- [ ] 定期更新镜像
- [ ] 备份数据库
- [ ] 监控日志
- [ ] 设置资源限制

### 监控和维护快速参考

#### 健康检查

```bash
# 检查服务健康状态
curl http://localhost:8080/health

# 检查数据库连接
docker exec cyp-registry pg_isready -U registry

# 检查 Redis 连接
docker exec cyp-registry redis-cli ping
```

#### 资源监控

```bash
# 查看容器资源使用
docker stats cyp-registry

# 查看磁盘使用
docker exec cyp-registry df -h

# 查看内存使用
docker exec cyp-registry free -h
```

#### 备份和恢复

```bash
# 备份数据库
docker exec cyp-registry pg_dump -U registry registry_db > backup.sql

# 恢复数据库
docker exec -i cyp-registry psql -U registry registry_db < backup.sql

# 备份存储
docker run --rm -v cyp-registry-storage:/data -v $(pwd):/backup \
  alpine tar czf /backup/storage-backup.tar.gz /data
```

---

## 总结

本文档提供了 CYP-Registry 系统的快速参考信息，包括：

- ✅ **平台支持矩阵**: 快速了解支持的平台和环境
- ✅ **环境要求检查**: 快速验证环境是否满足要求
- ✅ **配置快速参考**: 常用配置示例
- ✅ **部署命令参考**: 常用部署和运维命令
- ✅ **权限使用参考**: JWT 和 PAT 使用示例
- ✅ **清理操作参考**: 各种清理操作命令
- ✅ **故障排查参考**: 常见问题和解决方案
- ✅ **性能调优参考**: 性能优化配置
- ✅ **安全加固参考**: 安全配置和检查清单
- ✅ **监控维护参考**: 健康检查、资源监控、备份恢复

结合主文档 `系统平台环境架构完整文档.md`，可以全面了解系统的平台支持、环境要求、架构设计、兼容性、配置、权限、清理等各个方面。
