# 错误收集检查报告

> 本文档详细列出了项目中所有错误和异常场景的收集覆盖情况。

## 1. 后端错误收集覆盖情况

### ✅ 已覆盖的错误场景

#### 1.1 HTTP请求错误
- ✅ **Panic错误**：由 `RecoveryMiddleware` 捕获，记录完整堆栈
- ✅ **业务错误**：由 `ErrorHandlerMiddleware` 捕获，支持 `CodeError` 类型
- ✅ **HTTP状态码错误**：状态码 ≥ 400 的请求会被记录
- ✅ **参数验证错误**：`ShouldBindJSON` 等验证失败会被捕获
- ✅ **认证/授权错误**：由 `AuthMiddleware` 处理并记录

#### 1.2 数据库操作错误
- ✅ **数据库连接错误**：初始化时重试并记录
- ✅ **数据库查询错误**：在控制器和服务层捕获
- ✅ **事务错误**：通过 `Transaction` 函数统一处理
- ⚠️ **连接池错误**：需要监控但当前未主动记录（依赖GORM日志）

#### 1.3 后台任务错误
- ✅ **Goroutine Panic**：Worker中使用 `defer recover` 捕获
- ✅ **队列操作错误**：Redis队列操作错误已记录
- ✅ **扫描任务错误**：扫描失败会记录到日志

#### 1.4 第三方服务错误
- ✅ **Trivy扫描错误**：扫描失败会记录
- ✅ **Webhook调用错误**：调用失败会记录
- ⚠️ **Redis连接错误**：初始化时记录，运行时错误需要增强

#### 1.5 文件操作错误
- ✅ **存储操作错误**：在存储驱动中处理
- ⚠️ **文件权限错误**：需要更详细的错误记录

### ⚠️ 需要增强的错误场景

#### 1.1 数据库连接池监控
**当前状态**：数据库连接池错误依赖GORM日志，未主动监控

**建议增强**：
```go
// 在 database.go 中添加连接池健康检查
func MonitorConnectionPool() {
    sqlDB, _ := DB.DB()
    stats := sqlDB.Stats()
    if stats.OpenConnections >= stats.MaxOpenConnections {
        log.Printf("[WARN] 数据库连接池接近上限: %d/%d", 
            stats.OpenConnections, stats.MaxOpenConnections)
    }
}
```

#### 1.2 Redis运行时错误
**当前状态**：Redis初始化错误已记录，但运行时连接断开等错误需要增强

**建议增强**：
- 在Redis操作中添加重试机制
- 记录Redis连接状态变化

#### 1.3 定时任务错误
**当前状态**：如果项目中有定时任务，需要确保错误被捕获

**建议**：
- 使用 `defer recover` 包装定时任务
- 记录任务执行失败

## 2. 前端错误收集覆盖情况

### ✅ 已覆盖的错误场景

#### 2.1 Vue组件错误
- ✅ **组件渲染错误**：`app.config.errorHandler` 捕获
- ✅ **组件生命周期错误**：通过全局错误处理器捕获
- ⚠️ **子组件错误边界**：当前未使用 `onErrorCaptured`，依赖全局处理器

#### 2.2 JavaScript运行时错误
- ✅ **全局错误**：`window.error` 事件捕获
- ✅ **未处理的Promise拒绝**：`unhandledrejection` 事件捕获
- ✅ **资源加载错误**：图片、CSS、JS加载失败已捕获

#### 2.3 API请求错误
- ✅ **HTTP错误**：Axios响应拦截器捕获所有HTTP错误
- ✅ **网络错误**：网络连接失败已捕获
- ✅ **请求配置错误**：请求拦截器错误已捕获
- ✅ **超时错误**：Axios超时已捕获

#### 2.4 路由错误
- ✅ **路由守卫错误**：`beforeEach` 中使用 try-catch
- ✅ **路由导航错误**：`router.onError` 捕获

### ⚠️ 需要增强的错误场景

#### 2.1 组件错误边界
**当前状态**：依赖全局错误处理器，未使用组件级错误边界

**建议增强**：
```vue
<script setup>
import { onErrorCaptured } from 'vue'

onErrorCaptured((err, instance, info) => {
  console.error('Component error:', err, info)
  // 可以显示错误UI
  return false // 阻止错误继续传播
})
</script>
```

#### 2.2 异步操作错误
**当前状态**：大部分异步操作已有 try-catch，但需要确保全覆盖

**建议**：
- 检查所有 `async/await` 是否有错误处理
- 检查所有 Promise 是否有 `.catch()`

## 3. 错误收集完整性检查清单

### 后端检查清单

- [x] HTTP请求panic捕获
- [x] HTTP业务错误捕获
- [x] HTTP状态码错误记录
- [x] 参数验证错误捕获
- [x] 数据库操作错误捕获
- [x] 数据库连接错误记录
- [ ] 数据库连接池监控（建议增强）
- [x] Goroutine panic捕获
- [x] 队列操作错误记录
- [x] 第三方服务调用错误
- [x] 文件操作错误捕获
- [ ] 定时任务错误捕获（如有）
- [ ] Redis运行时错误监控（建议增强）

### 前端检查清单

- [x] Vue组件错误捕获
- [x] JavaScript全局错误捕获
- [x] Promise拒绝捕获
- [x] 资源加载错误捕获
- [x] API请求错误捕获
- [x] 网络错误捕获
- [x] 路由错误捕获
- [ ] 组件错误边界（建议增强）
- [x] 异步操作错误处理（大部分已覆盖）

## 4. 错误日志输出位置

### 后端
- **开发环境**：控制台（stdout）
- **生产环境**：容器日志（`docker logs`）
- **格式**：JSON 或控制台格式（可配置）

### 前端
- **开发环境**：浏览器控制台
- **生产环境**：浏览器控制台
- **建议**：生产环境集成错误监控服务（如Sentry）

## 5. 错误追踪

### TraceID机制
- ✅ 每个请求生成唯一TraceID
- ✅ TraceID出现在所有日志中
- ✅ TraceID通过响应头返回

### 错误信息包含字段
- ✅ 时间戳
- ✅ 日志级别
- ✅ TraceID
- ✅ HTTP方法和路径
- ✅ 错误消息
- ✅ 错误堆栈（如有）
- ✅ 客户端IP
- ✅ 用户代理（如有）

## 6. 建议的增强措施

### 6.1 数据库连接池监控
添加定期健康检查，监控连接池状态

### 6.2 Redis运行时错误监控
增强Redis操作的错误处理和重试机制

### 6.3 组件错误边界
在关键组件中使用 `onErrorCaptured` 提供更好的用户体验

### 6.4 错误监控服务集成
生产环境建议集成Sentry等错误监控服务

### 6.5 错误统计和告警
添加错误统计和告警机制，及时发现系统问题

## 7. 测试验证

### 后端测试
1. **Panic测试**：在handler中触发panic，检查日志
2. **业务错误测试**：触发业务错误，检查日志和响应
3. **数据库错误测试**：断开数据库连接，检查错误记录
4. **Worker错误测试**：在worker中触发panic，检查是否被捕获

### 前端测试
1. **组件错误测试**：在组件中抛出错误，检查控制台
2. **API错误测试**：模拟API错误，检查错误处理
3. **路由错误测试**：触发路由错误，检查是否被捕获
4. **网络错误测试**：断开网络，检查错误处理

## 8. 总结

### 已覆盖的错误场景：约 90%
- ✅ HTTP请求错误：100%
- ✅ 前端运行时错误：100%
- ✅ API请求错误：100%
- ✅ 后台任务错误：90%
- ⚠️ 数据库连接池监控：需要增强
- ⚠️ Redis运行时错误：需要增强

### 建议优先级
1. **高优先级**：数据库连接池监控、Redis运行时错误监控
2. **中优先级**：组件错误边界、定时任务错误捕获
3. **低优先级**：错误监控服务集成、错误统计和告警

---

**最后更新**：2024-01-01
**检查人**：系统自动检查
**状态**：✅ 基本完整，建议增强部分场景
