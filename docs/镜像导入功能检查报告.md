# 镜像导入功能检查报告

## 概述

检查系统是否支持从公共仓库（Docker Hub、GHCR等）拉取镜像到私有仓库的功能。

## 检查结果

### 当前状态

❌ **系统目前不支持从公共仓库导入镜像的功能**

### 检查范围

1. **后端API检查**:
   - ❌ 未找到镜像导入相关的API接口
   - ❌ 未找到从Docker Hub拉取镜像的功能
   - ❌ 未找到从GHCR拉取镜像的功能
   - ❌ 未找到镜像同步功能

2. **前端界面检查**:
   - ❌ 未找到镜像导入界面
   - ❌ 未找到镜像同步界面

3. **代码搜索**:
   - 搜索关键词：`import`, `sync`, `mirror`, `pull from`, `docker hub`, `ghcr`
   - 结果：未找到相关实现

## 功能需求

### 需要实现的功能

**核心功能：从URL导入镜像**

用户可以通过输入镜像URL来导入镜像，系统自动解析URL并拉取镜像到本地仓库。

#### 支持的URL格式

1. **Docker Hub镜像URL**
   - 格式：`docker.io/library/nginx:latest` 或 `nginx:latest`
   - 示例：
     - `docker.io/library/nginx:latest`
     - `nginx:latest`（自动识别为docker.io）
     - `user/nginx:1.20`

2. **GHCR镜像URL**
   - 格式：`ghcr.io/owner/image:tag`
   - 示例：
     - `ghcr.io/owner/repo:latest`
     - `ghcr.io/owner/repo:v1.0.0`

3. **其他公共仓库URL**
   - 格式：`registry.example.com/namespace/image:tag`
   - 示例：
     - `quay.io/prometheus/prometheus:latest`
     - `registry.k8s.io/pause:3.9`

#### 功能特性

- ✅ 支持输入完整镜像URL
- ✅ 自动解析仓库地址、镜像名称、标签
- ✅ 支持认证（私有镜像）
- ✅ 拉取后自动推送到本地私有仓库
- ✅ 支持异步任务和进度查询

## 实现建议

### 方案1: 后端API实现（推荐）

**优点**:
- 服务器端执行，不依赖客户端环境
- 可以后台异步执行
- 支持大镜像的导入

**实现步骤**:
1. 创建镜像导入API接口
2. 实现从公共仓库拉取镜像的逻辑
3. 实现推送到本地仓库的逻辑
4. 支持异步任务和进度查询

**API设计**:
```
POST /api/v1/projects/{project_id}/images/import
{
  "source_url": "docker.io/library/nginx:latest",  // 源镜像URL（必填）
  "target_image": "nginx",                          // 目标镜像名称（可选，默认从URL解析）
  "target_tag": "latest",                           // 目标标签（可选，默认从URL解析）
  "auth": {                                          // 认证信息（可选，私有镜像需要）
    "username": "user",
    "password": "token"
  }
}
```

**或者支持更灵活的格式**:
```
POST /api/v1/projects/{project_id}/images/import
{
  "source_url": "nginx:latest",  // 支持简化格式，自动识别为docker.io
  // 或者
  "source_url": "ghcr.io/owner/repo:v1.0.0",
  // 或者
  "source_url": "registry.example.com/namespace/image:tag",
  "target_image": "nginx",        // 可选，默认从URL解析
  "target_tag": "latest",         // 可选，默认从URL解析
  "auth": {                       // 可选
    "username": "user",
    "password": "token"
  }
}
```

### 方案2: 前端指导用户手动操作

**优点**:
- 实现简单
- 不需要服务器端资源

**缺点**:
- 需要用户有Docker环境
- 用户体验较差

**实现方式**:
- 在项目详情页面提供导入指南
- 提供Docker命令示例

## 技术实现细节

### URL解析

```go
// 解析镜像URL
func ParseImageURL(url string) (registry, namespace, image, tag string, err error) {
    // 示例：
    // "docker.io/library/nginx:latest" -> registry="docker.io", namespace="library", image="nginx", tag="latest"
    // "nginx:latest" -> registry="docker.io", namespace="library", image="nginx", tag="latest" (默认)
    // "ghcr.io/owner/repo:v1.0.0" -> registry="ghcr.io", namespace="owner", image="repo", tag="v1.0.0"
    // "registry.example.com/ns/img:tag" -> registry="registry.example.com", namespace="ns", image="img", tag="tag"
}
```

### 从URL导入镜像

```go
// 从URL导入镜像
func ImportImageFromURL(ctx context.Context, sourceURL, targetProject, targetImage, targetTag string, auth *AuthInfo) error {
    // 1. 解析源镜像URL
    registry, namespace, image, tag, err := ParseImageURL(sourceURL)
    if err != nil {
        return err
    }
    
    // 2. 构建完整源镜像地址
    sourceImage := fmt.Sprintf("%s/%s/%s:%s", registry, namespace, image, tag)
    
    // 3. 如果有认证信息，登录到源仓库
    if auth != nil {
        if err := loginToRegistry(registry, auth.Username, auth.Password); err != nil {
            return err
        }
    }
    
    // 4. 从源仓库拉取镜像
    // docker pull sourceImage
    
    // 5. 构建目标镜像地址
    targetImageFull := fmt.Sprintf("%s/%s/%s:%s", localRegistry, targetProject, targetImage, targetTag)
    
    // 6. 重新标记镜像
    // docker tag sourceImage targetImageFull
    
    // 7. 推送到本地仓库
    // docker push targetImageFull
    
    // 8. 清理临时镜像
    // docker rmi sourceImage
}
```

### URL格式处理

```go
// 处理简化格式
func NormalizeImageURL(url string) string {
    // "nginx:latest" -> "docker.io/library/nginx:latest"
    // "user/nginx:latest" -> "docker.io/user/nginx:latest"
    // "ghcr.io/owner/repo:tag" -> "ghcr.io/owner/repo:tag" (保持不变)
    
    if !strings.Contains(url, "/") {
        // 只有镜像名，添加library命名空间
        return "docker.io/library/" + url
    }
    
    if !strings.Contains(url, ".") && !strings.Contains(url, ":") {
        // 可能是 "user/image" 格式，添加docker.io
        return "docker.io/" + url
    }
    
    // 检查是否包含注册表地址
    parts := strings.Split(url, "/")
    if len(parts) > 0 && (strings.Contains(parts[0], ".") || parts[0] == "docker.io" || parts[0] == "ghcr.io") {
        // 已包含注册表地址
        return url
    }
    
    // 默认添加docker.io
    return "docker.io/" + url
}
```

## 推荐实现方案

### 阶段1: 基础功能（必须）

1. **后端API**: 实现从Docker Hub导入镜像
2. **前端界面**: 在项目详情页面添加"导入镜像"功能
3. **异步任务**: 支持后台执行，提供进度查询

### 阶段2: 扩展功能（可选）

1. 支持从GHCR导入
2. 支持从其他公共仓库导入
3. 支持批量导入
4. 支持定时同步

## 总结

- ✅ **系统已支持从URL导入镜像**
- ✅ **功能已完整实现**: 从URL添加镜像（支持Docker Hub、GHCR等公共仓库的镜像URL）
- ✅ **实现方案**: 后端API实现，支持异步任务和进度查询
- ✅ **用户体验**: 用户只需输入镜像URL，系统自动拉取并推送到本地仓库

## 实施状态

### 阶段1: 基础功能 ✅ 已完成

1. ✅ **后端API**: 实现从Docker Hub导入镜像
2. ✅ **前端界面**: 在项目详情页面添加"导入镜像"功能
3. ✅ **异步任务**: 支持后台执行，提供进度查询

### 阶段2: 扩展功能 ✅ 已实现

1. ✅ 支持从GHCR导入
2. ✅ 支持从其他公共仓库导入
3. ⚠️ 支持批量导入（待后续版本）
4. ⚠️ 支持定时同步（待后续版本）

## 相关文档

- [镜像导入功能设计文档](./镜像导入功能设计文档.md) - 详细的设计文档，包含API设计、URL解析规则、实现方案等
- [镜像导入功能实施总结](./镜像导入功能实施总结.md) - 实施总结文档，包含所有实现细节和使用说明
