# PAT Scopes 权限规范

## 概述

Personal Access Token (PAT) 使用 scopes 来限制令牌的权限范围。本文档定义了标准的 scopes 规范。

## 权限标识

### 管理员权限

- `admin` - 管理员所有权限（等同于 `admin:*`）
- `admin:*` - 管理员所有权限（通配符）
- `*` - 所有权限（等同于管理员，最高权限）

### 管理员子权限

- `admin:users` - 用户管理权限（查看、创建、更新、删除用户）
- `admin:projects` - 项目管理权限（查看、创建、更新、删除所有项目）
- `admin:logs` - 日志查看权限（查看系统审计日志）

### 项目权限

- `project:read` - 读取项目信息
- `project:write` - 编辑项目信息
- `project:delete` - 删除项目
- `project:*` - 项目所有权限

### 镜像权限

- `image:read` - 查看镜像列表和标签
- `image:push` - 推送镜像
- `image:pull` - 拉取镜像
- `image:delete` - 删除镜像和标签
- `image:*` - 镜像所有权限

### 标签权限

- `tag:read` - 查看标签信息
- `tag:delete` - 删除标签
- `tag:*` - 标签所有权限

### 通用权限

- `read` - 只读权限（适用于所有资源）
- `write` - 读写权限（适用于所有资源）

## 权限继承规则

1. **通配符权限**：`*` 和 `admin:*` 表示所有权限
2. **子权限继承**：拥有 `admin` 权限的用户自动拥有所有 `admin:*` 子权限
3. **资源权限**：拥有 `project:*` 权限的用户自动拥有该项目的所有子权限

## 权限检查规则

### AdminRequired 中间件

当使用 PAT 令牌访问需要管理员权限的接口时，系统会检查：

1. 用户必须是管理员（`user.IsAdmin = true`）
2. PAT 的 scopes 必须包含 `admin`、`admin:*` 或 `*`
3. **选择什么权限就是什么权限**：前端界面选择的权限选项直接对应后端的权限检查

### 权限验证流程

```
1. 验证 PAT 令牌有效性
2. 检查用户是否为管理员
3. 如果是 PAT 令牌：
   a. 检查 scopes 是否包含 admin、admin:* 或 *
   b. 如果不包含 → 返回错误码 30017
4. 如果是 JWT 令牌：
   → 继承用户所有权限，允许访问
5. 如果通过所有检查，允许访问
```

### 特殊说明

**权限精确控制**：
- 系统按照前端界面选择的权限进行精确控制
- 只选择"读取" → 只能读取
- 选择"读取"+"写入" → 可以读取和写入
- 选择"管理" → 可以访问所有功能（包括管理员功能）
- 不选择任何权限 → 无法访问任何需要权限的功能

## 使用示例

### 创建只读 PAT

**前端选择**：只勾选"读取"

```json
{
  "name": "只读令牌",
  "scopes": ["read"]
}
```

**可用功能**：
- ✅ 拉取镜像、查看项目信息
- ❌ 推送镜像、删除镜像、管理员功能

### 创建读写 PAT

**前端选择**：勾选"读取"和"写入"

```json
{
  "name": "读写令牌",
  "scopes": ["read", "write"]
}
```

**可用功能**：
- ✅ 拉取镜像、推送镜像、查看/创建项目
- ❌ 删除镜像、管理员功能

### 创建完整权限 PAT

**前端选择**：勾选"读取"、"写入"、"删除"

```json
{
  "name": "完整权限令牌",
  "scopes": ["read", "write", "delete"]
}
```

**可用功能**：
- ✅ 所有项目操作（拉取、推送、删除）
- ❌ 管理员功能

### 创建管理员 PAT

**前端选择**：勾选"管理"

```json
{
  "name": "管理员令牌",
  "scopes": ["admin"]
}
```

**可用功能**：
- ✅ 所有功能（包括管理员功能、查看日志等）

## 注意事项

1. **精确权限控制**：选择什么权限就是什么权限，系统会严格按照scopes进行权限检查
2. **最小权限原则**：只授予必要的权限，避免使用 `admin` scope（除非确实需要管理员功能）
3. **权限继承**：`delete` 包含 `write` 和 `read`，`write` 包含 `read`，`admin` 包含所有权限
4. **定期审查**：定期审查 PAT 的 scopes，确保符合实际需求
5. **及时撤销**：不再使用的 PAT 应及时撤销
6. **安全存储**：PAT 令牌应安全存储，不要提交到代码仓库

## 错误码说明

当权限不足时，系统会返回相应的错误码：

- `30014` - PAT缺少读取权限
- `30015` - PAT缺少写入权限
- `30016` - PAT缺少删除权限
- `30017` - PAT缺少管理员权限
- `30018` - PAT缺少权限信息
- `30019` - PAT权限信息格式错误

详细说明请参考 [权限系统完整文档](./权限系统完整文档.md)。
