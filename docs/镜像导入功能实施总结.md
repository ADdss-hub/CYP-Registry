# 镜像导入功能实施总结

## 概述

已完整实现从URL导入镜像功能，用户可以通过输入镜像URL（如 `docker.io/library/nginx:latest`、`ghcr.io/owner/repo:tag`）来导入镜像到本地私有仓库。

## 实施内容

### 阶段1: 基础功能 ✅ 已完成

#### 1. 后端API实现 ✅

**创建的文件**:
- `src/modules/imageimport/service/image_import_service.go` - 镜像导入服务
- `src/modules/imageimport/controller/image_import_controller.go` - 镜像导入控制器
- `src/modules/imageimport/models/import_task.go` - 导入任务模型
- `src/modules/imageimport/dto/image_import_dto.go` - 数据传输对象
- `src/modules/imageimport/init.go` - 数据库初始化

**API接口**:
- `POST /api/v1/projects/{project_id}/images/import` - 创建导入任务
- `GET /api/v1/projects/{project_id}/images/import/{task_id}` - 查询任务状态
- `GET /api/v1/projects/{project_id}/images/import` - 列出项目的导入任务

**功能特性**:
- ✅ URL解析：支持简化格式（如 `nginx:latest`）和完整格式
- ✅ Docker操作：使用Docker命令拉取、标记、推送镜像
- ✅ 异步任务：后台执行，不阻塞API响应
- ✅ 进度跟踪：实时更新任务进度和状态
- ✅ 错误处理：记录详细的错误信息

#### 2. 前端界面实现 ✅

**创建的文件**:
- `web/src/services/imageImport.ts` - 镜像导入API服务

**修改的文件**:
- `web/src/views/project/ProjectDetailView.vue` - 添加导入镜像对话框

**功能特性**:
- ✅ 导入对话框：支持输入镜像URL、目标镜像名、标签、认证信息
- ✅ 进度显示：实时显示任务进度、状态、消息
- ✅ 任务轮询：自动轮询任务状态，更新进度
- ✅ 错误提示：显示详细的错误信息
- ✅ 自动刷新：导入成功后自动刷新镜像列表

#### 3. 数据库表 ✅

**表名**: `image_import_tasks`

**字段**:
- `id`: UUID主键
- `project_id`: 项目ID
- `source_url`: 源镜像URL
- `source_image`: 完整源镜像地址
- `target_image`: 目标镜像名称
- `target_tag`: 目标标签
- `target_image_full`: 完整目标镜像地址
- `status`: 任务状态（pending/running/success/failed）
- `progress`: 进度（0-100）
- `message`: 状态消息
- `error`: 错误信息
- `user_id`: 用户ID
- `auth_username`: 认证用户名（加密存储）
- `auth_password`: 认证密码（加密存储）
- `created_at`: 创建时间
- `updated_at`: 更新时间
- `completed_at`: 完成时间

### 阶段2: 扩展功能 ✅ 已实现

#### 1. 支持从GHCR导入 ✅

- ✅ URL解析支持 `ghcr.io/owner/repo:tag` 格式
- ✅ 支持GitHub Token认证

#### 2. 支持从其他公共仓库导入 ✅

- ✅ URL解析支持任意注册表地址（如 `quay.io`、`registry.k8s.io`）
- ✅ 支持自定义认证信息

#### 3. 批量导入（待实现）

- ⚠️ 当前版本支持单个镜像导入
- 📝 批量导入功能可在后续版本中实现

#### 4. 定时同步（待实现）

- ⚠️ 当前版本不支持定时同步
- 📝 定时同步功能可在后续版本中实现

## URL解析规则

### 规则1: 简化格式识别

- `nginx:latest` → `docker.io/library/nginx:latest`
- `user/nginx:1.20` → `docker.io/user/nginx:1.20`

### 规则2: 默认注册表

- 如果不包含 `.` 或 `:`，且只有一个 `/`，默认为 `docker.io`
- 如果包含 `ghcr.io`、`quay.io` 等，使用指定的注册表

### 规则3: 标签处理

- 如果URL包含 `:`，使用指定的标签
- 如果不包含 `:`，默认使用 `latest`

## 使用示例

### 示例1: 从Docker Hub导入nginx

**输入**:
```json
{
  "source_url": "nginx:latest",
  "target_image": "nginx",
  "target_tag": "latest"
}
```

**执行过程**:
1. 解析URL → `docker.io/library/nginx:latest`
2. 拉取镜像 → `docker pull docker.io/library/nginx:latest`
3. 重新标记 → `docker tag docker.io/library/nginx:latest localhost:8080/my-project/nginx:latest`
4. 推送镜像 → `docker push localhost:8080/my-project/nginx:latest`

### 示例2: 从GHCR导入镜像

**输入**:
```json
{
  "source_url": "ghcr.io/owner/repo:v1.0.0",
  "target_image": "repo",
  "target_tag": "v1.0.0",
  "auth": {
    "username": "owner",
    "password": "ghp_xxxxxxxxxxxx"
  }
}
```

**执行过程**:
1. 解析URL → `ghcr.io/owner/repo:v1.0.0`
2. 登录GHCR → `docker login ghcr.io -u owner -p ghp_xxx`
3. 拉取镜像 → `docker pull ghcr.io/owner/repo:v1.0.0`
4. 重新标记并推送

## 技术实现

### Docker操作

使用 `os/exec` 执行Docker命令：

```go
// 拉取镜像
cmd := exec.CommandContext(ctx, "docker", "pull", imageURL)

// 重新标记
cmd := exec.CommandContext(ctx, "docker", "tag", sourceImage, targetImage)

// 推送镜像
cmd := exec.CommandContext(ctx, "docker", "push", imageURL)
```

### 异步任务执行

```go
// 创建任务后立即返回
task, err := s.ImportImageFromURL(...)

// 在goroutine中异步执行
go s.executeImport(ctx, task)
```

### 进度更新

```go
// 更新任务状态和进度
s.updateTaskStatus(taskID, models.TaskStatusRunning, 30, "正在拉取镜像...")
```

## 前端实现

### 导入对话框

- 输入镜像URL（必填）
- 目标镜像名称（可选）
- 目标标签（可选）
- 认证信息（可选，私有镜像需要）

### 进度显示

- 实时显示任务状态（pending/running/success/failed）
- 进度条显示完成百分比
- 状态消息显示当前操作
- 错误信息显示失败原因

### 任务轮询

```typescript
// 每2秒轮询一次任务状态
importTaskPolling.value = window.setInterval(async () => {
  const task = await imageImportApi.getTask(projectId, taskId);
  importTask.value = task;
  // 更新UI
}, 2000);
```

## 安全考虑

1. **认证信息存储**: 认证信息存储在数据库中，但不在API响应中返回
2. **Docker命令执行**: 使用 `exec.CommandContext` 执行Docker命令，支持超时控制
3. **错误处理**: 详细的错误信息帮助用户排查问题，但不泄露敏感信息

## 已知限制

1. **Docker依赖**: 需要服务器上安装Docker CLI
2. **网络访问**: 需要服务器能够访问源镜像仓库
3. **存储空间**: 导入过程中会临时占用存储空间
4. **并发限制**: 当前版本没有限制并发导入任务数量

## 后续优化建议

1. **批量导入**: 支持一次导入多个镜像
2. **定时同步**: 支持定时从源仓库同步镜像
3. **导入历史**: 显示导入历史记录
4. **重试机制**: 失败任务支持手动重试
5. **并发控制**: 限制同时执行的导入任务数量
6. **存储优化**: 导入完成后自动清理临时镜像

## 总结

- ✅ **阶段1完成**: 基础功能已完整实现
- ✅ **阶段2部分完成**: GHCR和其他公共仓库支持已实现
- ⚠️ **批量导入**: 待后续版本实现
- ⚠️ **定时同步**: 待后续版本实现

镜像导入功能已基本完成，可以满足用户从公共仓库导入镜像到私有仓库的需求。
