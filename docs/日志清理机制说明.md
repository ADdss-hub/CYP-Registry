# 日志清理机制说明

## 概述

系统实现了自动清理审计日志的机制，定期删除过期的日志记录，避免日志数据无限增长。

## 功能特性

### 自动清理

- ✅ **定时执行**: 默认每天执行一次清理任务
- ✅ **可配置保留天数**: 默认保留15天，可通过环境变量配置
- ✅ **可配置清理间隔**: 默认24小时，可通过环境变量配置
- ✅ **首次延迟**: 等待到下一个整点小时执行首次清理
- ✅ **后台运行**: 在独立的goroutine中运行，不影响主服务

### 清理策略

- **保留天数**: 只删除超过指定天数的日志
- **安全删除**: 使用数据库事务确保数据一致性
- **日志记录**: 记录清理前后的日志数量

## 配置说明

### 环境变量

| 环境变量 | 说明 | 默认值 | 示例 |
|---------|------|--------|------|
| `AUDIT_LOG_RETENTION_DAYS` | 日志保留天数 | 15 | `30` (保留30天) |
| `AUDIT_LOG_CLEANUP_INTERVAL_HOURS` | 清理间隔（小时） | 24 | `12` (每12小时清理一次) |

### 配置示例

```bash
# 保留30天日志，每12小时清理一次
export AUDIT_LOG_RETENTION_DAYS=30
export AUDIT_LOG_CLEANUP_INTERVAL_HOURS=12
```

## 实现细节

### 清理任务启动

在 `cmd/server/main.go` 中，服务器启动时自动启动清理任务：

```go
// 启动日志清理定时任务
go startAuditLogCleanupTask()
```

### 清理逻辑

1. **首次延迟**: 等待到下一个整点小时执行首次清理
2. **定时执行**: 使用 `time.Ticker` 定时执行清理
3. **清理操作**:
   - 计算截止日期（当前时间 - 保留天数）
   - 查询超过截止日期的日志数量
   - 删除超过截止日期的日志
   - 记录清理结果

### 代码位置

- **清理任务**: `cmd/server/audit_cleanup.go`
- **清理函数**: `src/pkg/audit/audit.go` 中的 `CleanupOldLogs`

## 使用示例

### 默认配置

```bash
# 不设置环境变量，使用默认值
# 保留15天，每24小时清理一次
```

### 自定义配置

```bash
# 保留60天，每6小时清理一次
export AUDIT_LOG_RETENTION_DAYS=60
export AUDIT_LOG_CLEANUP_INTERVAL_HOURS=6
```

### Docker Compose配置

```yaml
services:
  registry:
    environment:
      - AUDIT_LOG_RETENTION_DAYS=30
      - AUDIT_LOG_CLEANUP_INTERVAL_HOURS=12
```

## 日志输出

清理任务会输出以下日志：

```
审计日志清理任务已启动: 保留天数=15天, 清理间隔=24h0m0s, 首次执行延迟=1h30m0s
开始清理审计日志（保留15天）...
审计日志清理完成: 删除了 1234 条日志，当前剩余 5678 条日志
```

## 注意事项

1. **数据安全**: 清理操作不可逆，请根据实际需求设置保留天数
2. **性能影响**: 清理操作在后台异步执行，不会影响主服务性能
3. **数据库负载**: 大量日志清理时可能对数据库造成一定负载，建议在低峰期执行
4. **监控建议**: 建议监控清理任务的执行情况和日志数量

## 手动清理

如果需要手动清理日志，可以使用以下方法：

### 方法1: 通过数据库直接清理

```sql
-- 删除15天前的日志
DELETE FROM registry_audit_logs 
WHERE created_at < NOW() - INTERVAL '15 days';
```

### 方法2: 调用清理函数

```go
import "github.com/cyp-registry/registry/src/pkg/audit"

// 清理15天前的日志
err := audit.CleanupOldLogs(15)
```

## 总结

- ✅ **自动清理**: 系统自动定期清理过期日志
- ✅ **可配置**: 支持通过环境变量自定义保留天数和清理间隔
- ✅ **安全可靠**: 使用数据库事务确保数据一致性
- ✅ **性能优化**: 后台异步执行，不影响主服务

日志清理机制已完整实现，可以有效控制日志数据增长，保持系统性能。
