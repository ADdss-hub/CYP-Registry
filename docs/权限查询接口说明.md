# 权限查询接口说明

## 概述

系统提供了 `GET /api/v1/users/me/token-info` 接口，用于查询当前使用的认证方式（JWT或PAT）以及对应的权限信息。

## 接口详情

### 请求

**接口**: `GET /api/v1/users/me/token-info`

**认证**: 需要Bearer Token（JWT或PAT均可）

**请求头**:
```
Authorization: Bearer <token>
```

### 响应

**成功响应** (200):
```json
{
  "code": 20000,
  "message": "success",
  "data": {
    "token_type": "jwt",  // 或 "pat"
    "user": {
      "id": "123e4567-e89b-12d3-a456-426614174000",
      "username": "admin",
      "email": "admin@example.com",
      "nickname": "管理员",
      "avatar": "",
      "bio": "",
      "is_active": true,
      "is_admin": true,
      "created_at": "2025-01-01T00:00:00Z",
      "last_login_at": "2025-01-15T10:00:00Z"
    },
    "pat_id": null,  // 仅PAT token时返回
    "scopes": null,   // 仅PAT token时返回
    "has_read": true,
    "has_write": true,
    "has_delete": true,
    "has_admin": true
  }
}
```

**PAT Token响应示例**:
```json
{
  "code": 20000,
  "message": "success",
  "data": {
    "token_type": "pat",
    "user": {
      "id": "123e4567-e89b-12d3-a456-426614174000",
      "username": "admin",
      "email": "admin@example.com",
      "nickname": "管理员",
      "avatar": "",
      "bio": "",
      "is_active": true,
      "is_admin": true,
      "created_at": "2025-01-01T00:00:00Z",
      "last_login_at": "2025-01-15T10:00:00Z"
    },
    "pat_id": "456e7890-e89b-12d3-a456-426614174001",
    "scopes": ["read", "write"],
    "has_read": true,
    "has_write": true,
    "has_delete": false,
    "has_admin": false
  }
}
```

## 响应字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| `token_type` | string | Token类型：`"jwt"` 或 `"pat"` |
| `user` | object | 用户信息对象 |
| `pat_id` | string\|null | PAT ID（仅PAT token时返回，JWT token为null） |
| `scopes` | array\|null | PAT权限范围数组（仅PAT token时返回，JWT token为null） |
| `has_read` | boolean | 是否有读取权限 |
| `has_write` | boolean | 是否有写入权限 |
| `has_delete` | boolean | 是否有删除权限 |
| `has_admin` | boolean | 是否有管理员权限 |

## 权限判断规则

### JWT Token

- `token_type`: `"jwt"`
- `pat_id`: `null`
- `scopes`: `null`
- `has_read`: `true`（JWT token继承用户所有权限）
- `has_write`: `true`
- `has_delete`: `true`
- `has_admin`: 取决于用户是否为管理员（`user.is_admin`）

### PAT Token

- `token_type`: `"pat"`
- `pat_id`: PAT的UUID
- `scopes`: PAT的权限范围数组（如 `["read", "write"]`）
- `has_read`: 根据scopes计算（包含`read`、`write`、`delete`或`admin`时为`true`）
- `has_write`: 根据scopes计算（包含`write`、`delete`或`admin`时为`true`）
- `has_delete`: 根据scopes计算（包含`delete`或`admin`时为`true`）
- `has_admin`: 根据scopes计算（包含`admin`、`admin:*`或`*`时为`true`）

### 权限继承

PAT的权限继承规则：
- `delete` scope 包含 `write` 和 `read` 权限
- `write` scope 包含 `read` 权限
- `admin` scope 包含所有权限（`read`、`write`、`delete`、`admin`）

## 使用场景

### 1. 前端权限控制

前端可以根据返回的权限信息，动态显示或隐藏功能按钮：

```javascript
// 获取当前token信息
const response = await fetch('/api/v1/users/me/token-info', {
  headers: {
    'Authorization': `Bearer ${token}`
  }
});
const data = await response.json();

// 根据权限控制UI
if (data.data.has_write) {
  // 显示"推送镜像"按钮
}
if (data.data.has_delete) {
  // 显示"删除镜像"按钮
}
if (data.data.has_admin) {
  // 显示"管理员功能"菜单
}
```

### 2. 区分认证方式

前端可以区分当前使用的是JWT还是PAT：

```javascript
if (data.data.token_type === 'pat') {
  console.log('当前使用PAT令牌');
  console.log('PAT ID:', data.data.pat_id);
  console.log('权限范围:', data.data.scopes);
} else {
  console.log('当前使用JWT令牌');
}
```

### 3. 权限提示

当用户尝试执行无权限的操作时，可以显示友好的提示：

```javascript
async function pushImage() {
  const tokenInfo = await getTokenInfo();
  if (!tokenInfo.has_write) {
    alert('当前令牌缺少写入权限，无法推送镜像');
    return;
  }
  // 执行推送操作
}
```

## 错误响应

### 未授权 (401)

```json
{
  "code": 30001,
  "message": "未授权访问",
  "data": null
}
```

### 用户不存在 (404)

```json
{
  "code": 404,
  "message": "user not found",
  "data": null
}
```

## 注意事项

1. **JWT Token权限**: JWT token继承用户的所有权限，`has_read`、`has_write`、`has_delete` 始终为 `true`（除非用户被禁用）
2. **PAT Token权限**: PAT token的权限严格按照scopes计算，不会继承用户的所有权限
3. **管理员权限**: `has_admin` 对于JWT token取决于用户是否为管理员，对于PAT token取决于scopes是否包含`admin`
4. **权限继承**: PAT的权限继承规则会自动应用，例如拥有`write`权限的PAT，`has_read`也会为`true`

## 相关接口

- `GET /api/v1/users/me` - 获取当前用户信息（不包含token类型和权限信息）
- `GET /api/v1/users/me/pat` - 列出所有PAT（需要JWT token）
- `POST /api/v1/users/me/pat` - 创建PAT（需要JWT token）

## 完整示例

### cURL

```bash
# 使用JWT token查询
curl -X GET "http://localhost:8080/api/v1/users/me/token-info" \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."

# 使用PAT token查询
curl -X GET "http://localhost:8080/api/v1/users/me/token-info" \
  -H "Authorization: Bearer pat_v1_abc123..."
```

### JavaScript (Fetch API)

```javascript
async function getTokenInfo() {
  const token = localStorage.getItem('token');
  const response = await fetch('/api/v1/users/me/token-info', {
    headers: {
      'Authorization': `Bearer ${token}`
    }
  });
  
  if (!response.ok) {
    throw new Error('获取token信息失败');
  }
  
  const result = await response.json();
  return result.data;
}

// 使用示例
getTokenInfo().then(info => {
  console.log('Token类型:', info.token_type);
  console.log('用户:', info.user.username);
  console.log('权限:', {
    read: info.has_read,
    write: info.has_write,
    delete: info.has_delete,
    admin: info.has_admin
  });
  
  if (info.token_type === 'pat') {
    console.log('PAT ID:', info.pat_id);
    console.log('权限范围:', info.scopes);
  }
});
```

---

**最后更新**: 2025年1月
