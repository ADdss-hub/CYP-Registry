# 镜像导入功能设计文档

## 概述

实现从URL导入镜像功能，用户可以通过输入镜像URL（如 `docker.io/library/nginx:latest`、`ghcr.io/owner/repo:tag`）来导入镜像到本地私有仓库。

## 功能需求

### 核心功能

**从URL导入镜像**：用户输入镜像URL，系统自动拉取并推送到本地仓库。

### 支持的URL格式

#### 1. Docker Hub镜像

| 输入格式 | 完整URL | 说明 |
|---------|---------|------|
| `nginx:latest` | `docker.io/library/nginx:latest` | 简化格式，自动识别 |
| `user/nginx:1.20` | `docker.io/user/nginx:1.20` | 用户命名空间 |
| `docker.io/library/nginx:latest` | `docker.io/library/nginx:latest` | 完整格式 |

#### 2. GHCR镜像

| 输入格式 | 完整URL | 说明 |
|---------|---------|------|
| `ghcr.io/owner/repo:latest` | `ghcr.io/owner/repo:latest` | GitHub Container Registry |
| `ghcr.io/owner/repo:v1.0.0` | `ghcr.io/owner/repo:v1.0.0` | 指定版本 |

#### 3. 其他公共仓库

| 输入格式 | 完整URL | 说明 |
|---------|---------|------|
| `quay.io/prometheus/prometheus:latest` | `quay.io/prometheus/prometheus:latest` | Quay.io |
| `registry.k8s.io/pause:3.9` | `registry.k8s.io/pause:3.9` | Kubernetes Registry |
| `registry.example.com/ns/img:tag` | `registry.example.com/ns/img:tag` | 自定义仓库 |

## API设计

### 接口定义

**接口**: `POST /api/v1/projects/{project_id}/images/import`

**请求体**:
```json
{
  "source_url": "docker.io/library/nginx:latest",
  "target_image": "nginx",
  "target_tag": "latest",
  "auth": {
    "username": "user",
    "password": "token"
  }
}
```

**参数说明**:

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `source_url` | string | 是 | 源镜像URL |
| `target_image` | string | 否 | 目标镜像名称（默认从URL解析） |
| `target_tag` | string | 否 | 目标标签（默认从URL解析） |
| `auth` | object | 否 | 认证信息（私有镜像需要） |
| `auth.username` | string | 否 | 用户名 |
| `auth.password` | string | 否 | 密码或Token |

**响应**:
```json
{
  "code": 20000,
  "message": "success",
  "data": {
    "task_id": "uuid",
    "status": "pending",
    "source_url": "docker.io/library/nginx:latest",
    "target_image": "nginx",
    "target_tag": "latest"
  }
}
```

### 异步任务查询

**接口**: `GET /api/v1/projects/{project_id}/images/import/{task_id}`

**响应**:
```json
{
  "code": 20000,
  "data": {
    "task_id": "uuid",
    "status": "running",  // pending, running, success, failed
    "progress": 50,       // 0-100
    "message": "正在拉取镜像...",
    "source_url": "docker.io/library/nginx:latest",
    "target_image": "nginx",
    "target_tag": "latest",
    "error": null
  }
}
```

## 实现方案

### 后端实现

#### 1. URL解析模块

```go
// ParseImageURL 解析镜像URL
func ParseImageURL(url string) (registry, namespace, image, tag string, err error) {
    // 处理简化格式
    normalized := NormalizeImageURL(url)
    
    // 解析：registry/namespace/image:tag
    // ...
}
```

#### 2. 镜像导入服务

```go
// ImportImageService 镜像导入服务
type ImportImageService struct {
    registry *registry.Registry
    projectSvc project.Service
}

// ImportImageFromURL 从URL导入镜像
func (s *ImportImageService) ImportImageFromURL(
    ctx context.Context,
    projectID string,
    sourceURL string,
    targetImage string,
    targetTag string,
    auth *AuthInfo,
) (*ImportTask, error) {
    // 1. 解析URL
    // 2. 创建异步任务
    // 3. 后台执行导入
    // 4. 返回任务ID
}
```

#### 3. 异步任务执行

```go
// 后台任务执行
func (s *ImportImageService) executeImport(ctx context.Context, task *ImportTask) {
    // 1. 登录到源仓库（如果需要）
    // 2. 拉取镜像
    // 3. 重新标记
    // 4. 推送到本地仓库
    // 5. 更新任务状态
}
```

### 前端实现

#### 1. 导入对话框

在项目详情页面添加"导入镜像"按钮，打开导入对话框：

```vue
<template>
  <CypDialog v-model="showImportDialog" title="导入镜像">
    <CypForm>
      <CypFormItem label="镜像URL">
        <CypInput 
          v-model="importForm.source_url" 
          placeholder="例如: docker.io/library/nginx:latest"
        />
      </CypFormItem>
      <CypFormItem label="目标镜像名称（可选）">
        <CypInput v-model="importForm.target_image" />
      </CypFormItem>
      <CypFormItem label="目标标签（可选）">
        <CypInput v-model="importForm.target_tag" />
      </CypFormItem>
      <CypFormItem label="认证信息（可选，私有镜像需要）">
        <CypInput v-model="importForm.auth.username" placeholder="用户名" />
        <CypInput v-model="importForm.auth.password" type="password" placeholder="密码/Token" />
      </CypFormItem>
    </CypForm>
  </CypDialog>
</template>
```

#### 2. 进度显示

显示导入进度和状态：

```vue
<template>
  <div v-if="importTask">
    <div>状态: {{ importTask.status }}</div>
    <div>进度: {{ importTask.progress }}%</div>
    <div>消息: {{ importTask.message }}</div>
  </div>
</template>
```

## URL解析规则

### 规则1: 简化格式识别

- `nginx:latest` → `docker.io/library/nginx:latest`
- `user/nginx:1.20` → `docker.io/user/nginx:1.20`

### 规则2: 默认注册表

- 如果不包含 `.` 或 `:`，且只有一个 `/`，默认为 `docker.io`
- 如果包含 `ghcr.io`、`quay.io` 等，使用指定的注册表

### 规则3: 标签处理

- 如果URL包含 `:`，使用指定的标签
- 如果不包含 `:`，默认使用 `latest`

## 使用示例

### 示例1: 从Docker Hub导入nginx

**输入**:
```json
{
  "source_url": "nginx:latest",
  "target_image": "nginx",
  "target_tag": "latest"
}
```

**执行过程**:
1. 解析URL → `docker.io/library/nginx:latest`
2. 拉取镜像 → `docker pull docker.io/library/nginx:latest`
3. 重新标记 → `docker tag docker.io/library/nginx:latest localhost:8080/my-project/nginx:latest`
4. 推送镜像 → `docker push localhost:8080/my-project/nginx:latest`

### 示例2: 从GHCR导入镜像

**输入**:
```json
{
  "source_url": "ghcr.io/owner/repo:v1.0.0",
  "target_image": "repo",
  "target_tag": "v1.0.0",
  "auth": {
    "username": "owner",
    "password": "ghp_xxxxxxxxxxxx"
  }
}
```

**执行过程**:
1. 解析URL → `ghcr.io/owner/repo:v1.0.0`
2. 登录GHCR → `docker login ghcr.io -u owner -p ghp_xxx`
3. 拉取镜像 → `docker pull ghcr.io/owner/repo:v1.0.0`
4. 重新标记并推送

## 技术实现

### 使用Docker API

可以使用Docker Go SDK或直接调用Docker命令：

```go
import "github.com/docker/docker/client"

// 使用Docker Go SDK
cli, err := client.NewClientWithOpts(client.FromEnv)
if err != nil {
    return err
}

// 拉取镜像
reader, err := cli.ImagePull(ctx, sourceImage, types.ImagePullOptions{})
// ...
```

### 或使用exec执行Docker命令

```go
import "os/exec"

// 拉取镜像
cmd := exec.Command("docker", "pull", sourceImage)
// ...
```

## 总结

### 功能特点

- ✅ **简单易用**: 只需输入镜像URL
- ✅ **自动解析**: 自动识别仓库地址、镜像名称、标签
- ✅ **支持多种格式**: Docker Hub、GHCR、其他公共仓库
- ✅ **异步执行**: 支持后台任务和进度查询
- ✅ **认证支持**: 支持私有镜像导入

### 实现优先级

1. **阶段1**: 支持Docker Hub URL导入（简化格式和完整格式）
2. **阶段2**: 支持GHCR URL导入
3. **阶段3**: 支持其他公共仓库URL导入
4. **阶段4**: 支持批量导入、定时同步等高级功能
